<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${cspSource} 'unsafe-inline'; script-src ${cspSource} 'unsafe-inline'; img-src ${cspSource} data:; connect-src ${cspSource};">
  <title>Axiom ì±„íŒ…</title>
  <link href="${cssUri}" rel="stylesheet">
  <script>
    // ë””ë²„ê¹… í—¬í¼
    window.axiomDebug = {
      log: function(message) {
        console.log('[Axiom Debug]:', message);
      }
    };
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë””ë²„ê¹… ë©”ì‹œì§€
    window.addEventListener('DOMContentLoaded', function() {
      axiomDebug.log('ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ ë¡œë“œë¨');
      axiomDebug.log('CSS URI: ${cssUri}');
      axiomDebug.log('ëª¨ë¸ ì„ íƒê¸° URI: ${modelSelectorUri}');
    });
  </script>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1><span class="logo">âš¡</span> Axiom ì±„íŒ…</h1>
      <div id="modelSelector" class="model-selector"></div>
    </div>
    
    <div class="chat-messages" id="messages">
      <!-- ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ -->
      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">âš¡</div>
        <div class="empty-state-title">Axiomê³¼ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
        <div class="empty-state-text">ì§ˆë¬¸ì´ë‚˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      </div>
      
      <!-- ë©”ì‹œì§€ëŠ” ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
    
    <div class="chat-input-container">
      <div class="toolbar">
        <button class="toolbar-button" id="clearButton" title="ëŒ€í™” ë‚´ìš© ì§€ìš°ê¸°">
          ğŸ§¹ ì§€ìš°ê¸°
        </button>
      </div>
      
      <div class="input-wrapper">
        <textarea id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." rows="1"></textarea>
        <button id="sendButton" class="send-button" disabled>â†‘</button>
      </div>
    </div>
  </div>

  <script src="${modelSelectorUri}"></script>
  <script>
    (function() {
      // VS Code API
      const vscode = acquireVsCodeApi();
      
      // DOM ìš”ì†Œ
      const messagesContainer = document.getElementById('messages');
      const chatInput = document.getElementById('chatInput');
      const sendButton = document.getElementById('sendButton');
      const clearButton = document.getElementById('clearButton');
      const emptyState = document.getElementById('emptyState');
      
      // ëª¨ë¸ ì„ íƒê¸° ì¸ìŠ¤í„´ìŠ¤
      let modelSelector;
      
      // ë©”ì‹œì§€ ìƒíƒœ ê´€ë¦¬
      let messageState = vscode.getState() || { messages: [] };
      
      // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ê´€ë¦¬
      let streamingState = {
        activeStreams: {},
        isStreaming: false
      };
      
      // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í¬ê¸° ì¡°ì ˆ
      function autoResizeTextarea() {
        chatInput.style.height = 'auto';
        chatInput.style.height = (chatInput.scrollHeight) + 'px';
      }
      
      // ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™
      function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // ë©”ì‹œì§€ í‘œì‹œ ì—…ë°ì´íŠ¸
      function updateMessageDisplay() {
        if (messageState.messages.length > 0) {
          emptyState.style.display = 'none';
        } else {
          emptyState.style.display = 'flex';
        }
      }
      
      // ì´ˆê¸° ë©”ì‹œì§€ ë Œë”ë§
      function renderMessages() {
        if (messageState.messages.length > 0) {
          emptyState.style.display = 'none';
          
          messageState.messages.forEach(msg => {
            addMessageToDOM(msg);
          });
          
          scrollToBottom();
        }
      }
      
      // DOMì— ë©”ì‹œì§€ ì¶”ê°€
      function addMessageToDOM(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        
        if (message.type === 'user') {
          messageElement.classList.add('message-user');
        } else if (message.type === 'assistant') {
          messageElement.classList.add('message-assistant');
        } else if (message.type === 'system') {
          messageElement.classList.add('message-system');
        }
        
        // ID ì„¤ì • (ìŠ¤íŠ¸ë¦¬ë°ìš©)
        if (message.id) {
          messageElement.setAttribute('id', message.id);
        }
        
        messageElement.textContent = message.content;
        messagesContainer.appendChild(messageElement);
        return messageElement;
      }
      
      // ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±
      function createStreamingMessageElement(responseId, type) {
        // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë° ìš”ì†Œê°€ ìˆëŠ”ì§€ í™•ì¸
        const existingElement = document.getElementById(responseId);
        if (existingElement) {
          return existingElement;
        }
        
        // ìƒˆ ìš”ì†Œ ìƒì„±
        const message = { 
          type: type, 
          content: '', 
          id: responseId,
          timestamp: Date.now() 
        };
        
        // ìƒíƒœì— ë©”ì‹œì§€ ì¶”ê°€í•˜ì§€ ì•ŠìŒ (ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ì¶”ê°€)
        const element = addMessageToDOM(message);
        
        // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        streamingState.activeStreams[responseId] = {
          element: element,
          content: ''
        };
        
        streamingState.isStreaming = true;
        
        return element;
      }
      
      // ë©”ì‹œì§€ ì¶”ê°€
      function addMessage(type, content) {
        const message = { type, content, timestamp: Date.now() };
        
        // ìƒíƒœì— ì¶”ê°€
        messageState.messages.push(message);
        vscode.setState(messageState);
        
        // DOMì— ì¶”ê°€
        addMessageToDOM(message);
        updateMessageDisplay();
        scrollToBottom();
      }
      
      // ë©”ì‹œì§€ ì „ì†¡
      function sendMessage() {
        const text = chatInput.value.trim();
        if (text) {
          // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
          addMessage('user', text);
          
          // ì„ íƒëœ ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
          const selectedModel = modelSelector ? modelSelector.getCurrentModelId() : null;
          
          // VS Codeì— ë©”ì‹œì§€ ì „ì†¡
          vscode.postMessage({
            command: 'sendMessage',
            text: text,
            model: selectedModel
          });
          
          // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
          chatInput.value = '';
          chatInput.style.height = 'auto';
          sendButton.disabled = true;
        }
      }
      
      // ì±„íŒ… ì´ˆê¸°í™”
      function clearChat() {
        messagesContainer.innerHTML = '';
        messagesContainer.appendChild(emptyState);
        emptyState.style.display = 'flex';
        
        messageState.messages = [];
        vscode.setState(messageState);
        
        // ì›¹ë·° ì´ˆê¸°í™” ì‹œì—ë§Œ ì„œë²„ì— ì•Œë¦¼ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œëœ ê²½ìš°ëŠ” ì œì™¸)
        if (!clearingFromServer) {
          vscode.postMessage({
            command: 'clearChat'
          });
        }
      }
      
      // ì„œë²„ì—ì„œ ì´ˆê¸°í™” ìš”ì²­ ì‹œ í”Œë˜ê·¸
      let clearingFromServer = false;
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      chatInput.addEventListener('input', () => {
        sendButton.disabled = chatInput.value.trim() === '';
        autoResizeTextarea();
      });
      
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!sendButton.disabled) {
            sendMessage();
          }
        }
      });
      
      sendButton.addEventListener('click', sendMessage);
      clearButton.addEventListener('click', clearChat);
      
      // ëª¨ë¸ ëª©ë¡ ì—…ë°ì´íŠ¸
      function updateModelList(models) {
        if (!models || !Array.isArray(models)) {
          console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ëª¨ë¸ ëª©ë¡:', models);
          return;
        }
        
        // ëª¨ë¸ ì„ íƒê¸°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš° ì´ˆê¸°í™”
        if (!modelSelector) {
          modelSelector = new ModelSelector('modelSelector', {
            models: models,
            onChange: (modelId) => {
              // ëª¨ë¸ ë³€ê²½ ì´ë²¤íŠ¸ ì²˜ë¦¬
              vscode.postMessage({
                command: 'changeModel',
                model: modelId
              });
              
              // ëª¨ë¸ ë³€ê²½ì‹œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
              const selectedModel = models.find(model => model.id === modelId);
              if (selectedModel) {
                addMessage('system', `ëª¨ë¸ì´ ${selectedModel.name}(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              }
            }
          });
        } else {
          // ê¸°ì¡´ ì„ íƒê¸°ì˜ ëª¨ë¸ ëª©ë¡ ì—…ë°ì´íŠ¸
          modelSelector.options.models = models;
          modelSelector.updateModels(models);
        }
      }
      
      // í˜„ì¬ ëª¨ë¸ ì„¤ì •
      function setCurrentModel(modelId) {
        if (modelSelector && modelId) {
          modelSelector.setModelById(modelId);
        }
      }

      // VS Codeë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
      window.addEventListener('message', event => {
        const message = event.data;
        
        console.log('VS Codeì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ :', message.command);
        
        switch (message.command) {
          case 'initialized':
            console.log('VS Code í™•ì¥ì—ì„œ ì´ˆê¸°í™” ì™„ë£Œ ë©”ì‹œì§€ ìˆ˜ì‹ ');
            addMessage('system', 'ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            break;
            
          case 'addMessage':
            addMessage(message.type, message.content);
            break;
            
          case 'clearChat':
            clearingFromServer = true;
            clearChat();
            clearingFromServer = false;
            break;
            
          case 'updateModels':
            console.log('ëª¨ë¸ ëª©ë¡ ì—…ë°ì´íŠ¸ ìš”ì²­ ìˆ˜ì‹ :', message.models);
            updateModelList(message.models);
            break;
            
          case 'setCurrentModel':
            console.log('í˜„ì¬ ëª¨ë¸ ì„¤ì • ìš”ì²­ ìˆ˜ì‹ :', message.modelId);
            setCurrentModel(message.modelId);
            break;
            
          case 'removeSystemMessage':
            console.log('ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±° ìš”ì²­ ìˆ˜ì‹ :', message.content);
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±° ë¡œì§ (í•„ìš”ì‹œ êµ¬í˜„)
            break;
            
          // ìŠ¤íŠ¸ë¦¬ë° ê´€ë ¨ ëª…ë ¹ì–´
          case 'startStreaming':
            console.log('ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘:', message.responseId);
            createStreamingMessageElement(message.responseId, message.type);
            updateMessageDisplay();
            scrollToBottom();
            break;
            
          case 'appendStreamChunk':
            // ìŠ¤íŠ¸ë¦¬ë° ì²­í¬ ì¶”ê°€
            if (streamingState.activeStreams[message.responseId]) {
              const stream = streamingState.activeStreams[message.responseId];
              stream.content += message.content;
              stream.element.textContent = stream.content;
              stream.element.classList.add('streaming');
              scrollToBottom();
            } else {
              console.warn('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìŠ¤íŠ¸ë¦¼ì— ì²­í¬ ì¶”ê°€ ì‹œë„:', message.responseId);
            }
            break;
            
          case 'endStreaming':
            console.log('ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ:', message.responseId);
            if (streamingState.activeStreams[message.responseId]) {
              // ìŠ¤íŠ¸ë¦¼ ì½˜í…ì¸ ë¥¼ ë©”ì‹œì§€ ìƒíƒœì— ì €ì¥
              const stream = streamingState.activeStreams[message.responseId];
              const element = stream.element;
              const type = element.classList.contains('message-assistant') ? 'assistant' : 
                           element.classList.contains('message-system') ? 'system' : 'assistant';
              
              // ìŠ¤íŠ¸ë¦¬ë° ì• ë‹ˆë©”ì´ì…˜ ì œê±°
              element.classList.remove('streaming');
              
              // ë©”ì‹œì§€ ìƒíƒœì— ì¶”ê°€
              messageState.messages.push({
                type: type,
                content: stream.content,
                timestamp: Date.now()
              });
              vscode.setState(messageState);
              
              // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœì—ì„œ ì œê±°
              delete streamingState.activeStreams[message.responseId];
              if (Object.keys(streamingState.activeStreams).length === 0) {
                streamingState.isStreaming = false;
              }
            }
            break;
            
          default:
            console.log('ì²˜ë¦¬ë˜ì§€ ì•Šì€ ë©”ì‹œì§€ íƒ€ì…:', message.command);
        }
      });
      
      // ì´ˆê¸° ë Œë”ë§
      renderMessages();
    })();
  </script>
</body>
</html>