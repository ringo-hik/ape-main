/**
 * ë„ì›€ë§ ë Œë”ëŸ¬ (ì¹´ë“œ ê¸°ë°˜ UI)
 * 
 * ë„ì›€ë§ ë°ì´í„°ë¥¼ ì›¹ë·°ì— í‘œì‹œí•˜ê¸° ìœ„í•œ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 * ì¹´ë“œ ê¸°ë°˜ UIë¡œ ëª…ë ¹ì–´ë¥¼ ì§ì ‘ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì¸í„°ë™í‹°ë¸Œ í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤.
 */

import * as vscode from 'vscode';
import * as path from 'path';
import * as fs from 'fs';
import { LLMService } from '../llm/llmService';

// vscode í™•ì¥ ì¸ìŠ¤í„´ìŠ¤ ìºì‹œ
let _extensionContext: vscode.ExtensionContext | undefined;

/**
 * í™•ì¥ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
 * @param context VS Code í™•ì¥ ì»¨í…ìŠ¤íŠ¸
 */
export function setExtensionContext(context: vscode.ExtensionContext): void {
  _extensionContext = context;
}

/**
 * Codicon CSS íŒŒì¼ì— ëŒ€í•œ URI ê°€ì ¸ì˜¤ê¸°
 */
function getCodiconCssUri(): vscode.Uri {
  const extension = vscode.extensions.getExtension('ape-team.ape-extension');
  if (!extension) {
    throw new Error('APE í™•ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
  
  return vscode.Uri.joinPath(extension.extensionUri, 'media', 'codicon', 'codicon.css');
}

/**
 * ì±„íŒ… APE CSS íŒŒì¼ì— ëŒ€í•œ URI ê°€ì ¸ì˜¤ê¸°
 */
function getChatApeCssUri(): vscode.Uri {
  const extension = vscode.extensions.getExtension('ape-team.ape-extension');
  if (!extension) {
    throw new Error('APE í™•ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
  
  return vscode.Uri.joinPath(extension.extensionUri, 'media', 'chat-ape.css');
}

/**
 * ì±„íŒ… APE ë²„íŠ¼ CSS íŒŒì¼ì— ëŒ€í•œ URI ê°€ì ¸ì˜¤ê¸°
 */
function getChatApeButtonsCssUri(): vscode.Uri {
  const extension = vscode.extensions.getExtension('ape-team.ape-extension');
  if (!extension) {
    throw new Error('APE í™•ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
  
  return vscode.Uri.joinPath(extension.extensionUri, 'media', 'chat-ape-buttons.css');
}

/**
 * ì›°ì»´ CSS íŒŒì¼ì— ëŒ€í•œ URI ê°€ì ¸ì˜¤ê¸°
 */
function getWelcomeCssUri(): vscode.Uri {
  const extension = vscode.extensions.getExtension('ape-team.ape-extension');
  if (!extension) {
    throw new Error('APE í™•ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
  
  return vscode.Uri.joinPath(extension.extensionUri, 'media', 'welcome.css');
}

import {
  generateHelpSystemPrompt,
} from '../../data/helpSystemPrompt';

// ë„ì›€ë§ ë°ì´í„° ìºì‹œ
let helpDataCache: any = null;

/**
 * ë„ì›€ë§ ë°ì´í„° ë¡œë“œ
 * @returns ë„ì›€ë§ ë°ì´í„° ê°ì²´
 */
export async function loadHelpData(): Promise<any> {
  if (helpDataCache) {
    return helpDataCache;
  }

  try {
    const extensionPath = vscode.extensions.getExtension('ape-team.ape-extension')?.extensionPath;
    if (!extensionPath) {
      throw new Error('í™•ì¥ í”„ë¡œê·¸ë¨ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const helpFilePath = path.join(extensionPath, 'src', 'data', 'help.json');
    const helpDataStr = fs.readFileSync(helpFilePath, 'utf8');
    helpDataCache = JSON.parse(helpDataStr);
    return helpDataCache;
  } catch (error) {
    console.error('ë„ì›€ë§ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    throw new Error('ë„ì›€ë§ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
}

/**
 * íŠ¹ì • ëª…ë ¹ì–´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
 * @param commandName ëª…ë ¹ì–´ ì´ë¦„
 * @returns ëª…ë ¹ì–´ ë°ì´í„° ê°ì²´
 */
export async function getCommandData(commandName: string): Promise<any | null> {
  try {
    const helpData = await loadHelpData();
    
    // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰
    for (const category of helpData.categories) {
      // ì¹´í…Œê³ ë¦¬ ë‚´ ëª…ë ¹ì–´ ê²€ìƒ‰
      for (const command of category.commands) {
        // ëª…ë ¹ì–´ ì´ë¦„ ë˜ëŠ” ë³„ì¹­ ë§¤ì¹­
        if (command.name === commandName || (command.aliases && command.aliases.includes(commandName))) {
          return {
            ...command,
            category: category.id,
            categoryName: category.name
          };
        }
      }
    }
    
    return null;
  } catch (error) {
    console.error('ëª…ë ¹ì–´ ë°ì´í„° ê²€ìƒ‰ ì˜¤ë¥˜:', error);
    return null;
  }
}

/**
 * ì¹´í…Œê³ ë¦¬ë³„ ëª…ë ¹ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
 * @param categoryId ì¹´í…Œê³ ë¦¬ ID (ì˜µì…˜)
 * @returns ì¹´í…Œê³ ë¦¬ë³„ ëª…ë ¹ì–´ ëª©ë¡
 */
export async function getCommandsByCategory(categoryId?: string): Promise<any[]> {
  try {
    const helpData = await loadHelpData();
    
    // íŠ¹ì • ì¹´í…Œê³ ë¦¬ ìš”ì²­ ì‹œ
    if (categoryId) {
      const category = helpData.categories.find((c: any) => c.id === categoryId);
      return category ? [category] : [];
    }
    
    // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë°˜í™˜
    return helpData.categories;
  } catch (error) {
    console.error('ì¹´í…Œê³ ë¦¬ë³„ ëª…ë ¹ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
    return [];
  }
}

/**
 * ë„ì›€ë§ HTML ìƒì„± (ì¹´ë“œ ê¸°ë°˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡)
 * @param categoryId ì¹´í…Œê³ ë¦¬ ID (ì˜µì…˜)
 * @returns HTML ë¬¸ìì—´
 */
export async function generateHelpHtml(categoryId?: string): Promise<string> {
  try {
    const categories = await getCommandsByCategory(categoryId);
    
    let content = `
      <div class="help-container">
        <div class="help-header">
          <h1 class="help-title">APE ë„ì›€ë§</h1>
          <div class="title-separator"></div>
          <p class="help-tagline">ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡</p>
          <p class="help-subtitle">ëª…ë ¹ì–´ë¥¼ í´ë¦­í•˜ë©´ ë°”ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>
        </div>
        
        <div class="quick-actions">
          <h2>ìì£¼ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´</h2>
          <div class="quick-buttons">
            <button class="quick-button git" onclick="executeCommand('git status')">
              <span class="emoji-icon">âš™ï¸</span>Git ìƒíƒœ
            </button>
            <button class="quick-button code" onclick="executeCommand('analyze')">
              <span class="emoji-icon">ğŸ”</span>ì½”ë“œ ë¶„ì„
            </button>
            <button class="quick-button utility" onclick="executeCommand('clear')">
              <span class="emoji-icon">ğŸ§¹</span>ì±„íŒ… ì§€ìš°ê¸°
            </button>
            <button class="quick-button model" onclick="executeCommand('model list')">
              <span class="emoji-icon">ğŸ¤–</span>ëª¨ë¸ ì„ íƒ
            </button>
          </div>
        </div>
        
        <div class="category-tabs">
          ${categories.map(category => `
            <div class="category-tab" data-category="${category.id}">
              <span class="category-icon">${getCategoryEmoji(category.id)}</span>
              <span class="category-name">${category.name}</span>
            </div>
          `).join('')}
        </div>
    `;
    
    // ì¹´í…Œê³ ë¦¬ë³„ ëª…ë ¹ì–´ ì„¹ì…˜
    content += `<div class="category-sections">`;
    
    // Git ì¹´í…Œê³ ë¦¬ëŠ” íŠ¹ë³„ ì²˜ë¦¬ (í•­ìƒ ë” ê°•ì¡°í•˜ì—¬ í‘œì‹œ)
    const gitCategory = categories.find(cat => cat.id === 'git');
    if (gitCategory) {
      content += `
        <div class="category-section active" id="category-git">
          <h2>${gitCategory.name}</h2>
          <p>${gitCategory.description || ''}</p>
          <div class="git-commands-container">
            ${generateGitCommandCards(gitCategory.commands)}
          </div>
        </div>
      `;
    }
    
    // ë‚˜ë¨¸ì§€ ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
    for (const category of categories) {
      if (category.id !== 'git') {
        content += `
          <div class="category-section ${category.id === (categoryId || 'general') ? 'active' : ''}" id="category-${category.id}">
            <h2>${category.name}</h2>
            <p>${category.description || ''}</p>
            <div class="command-grid">
              ${generateCommandCards(category.commands)}
            </div>
          </div>
        `;
      }
    }
    
    content += `</div>`; // category-sections ì¢…ë£Œ
    content += `</div>`; // help-container ì¢…ë£Œ
    
    // ì „ì²´ HTML ë˜í•‘
    return getHelpPageHtml(content);
  } catch (error) {
    console.error('ë„ì›€ë§ HTML ìƒì„± ì˜¤ë¥˜:', error);
    return getHelpPageHtml(`
      <div class="help-container">
        <h1>ë„ì›€ë§ ë¡œë“œ ì˜¤ë¥˜</h1>
        <p>ë„ì›€ë§ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}</p>
      </div>
    `);
  }
}

/**
 * Git ëª…ë ¹ì–´ ì¹´ë“œ HTML ìƒì„± (íŠ¹ë³„ ê°•ì¡° ì²˜ë¦¬)
 * @param commands Git ëª…ë ¹ì–´ ë°°ì—´
 * @returns HTML ë¬¸ìì—´
 */
function generateGitCommandCards(commands: any[]): string {
  let html = `<div class="git-commands-grid">`;
  
  for (const command of commands) {
    const commandIcon = getCommandIcon(command.name);
    const shortDesc = command.description.length > 70 ? command.description.substring(0, 67) + '...' : command.description;
    
    html += `
      <div class="git-command-card" onclick="executeCommand('${command.name}')" title="${command.description}">
        <div class="git-command-header">
          <div class="git-command-icon">${commandIcon}</div>
          <div class="git-command-name">/${command.name}</div>
        </div>
        <div class="git-command-description">${shortDesc}</div>
        <div class="git-command-footer">
          ${command.examples && command.examples.length > 0 ? 
            `<div class="git-command-example">${command.examples[0]}</div>` : ''}
          <div class="git-command-button">ì‹¤í–‰</div>
        </div>
      </div>
    `;
  }
  
  html += `</div>`;
  return html;
}

/**
 * ì¼ë°˜ ëª…ë ¹ì–´ ì¹´ë“œ HTML ìƒì„±
 * @param commands ëª…ë ¹ì–´ ë°°ì—´
 * @returns HTML ë¬¸ìì—´
 */
function generateCommandCards(commands: any[]): string {
  let html = '';
  
  for (const command of commands) {
    const commandIcon = getCommandIcon(command.name);
    const shortDesc = command.description.length > 60 ? command.description.substring(0, 57) + '...' : command.description;
    
    html += `
      <div class="command-card" onclick="executeCommand('${command.name}')" title="${command.description}">
        <div class="command-icon">${commandIcon}</div>
        <div class="command-content">
          <div class="command-name">/${command.name}</div>
          <div class="command-description">${shortDesc}</div>
          ${command.aliases && command.aliases.length > 0 ? 
            `<div class="command-aliases">ë³„ì¹­: ${command.aliases.map((a: string) => `/${a}`).join(', ')}</div>` : ''}
        </div>
      </div>
    `;
  }
  
  return html;
}

/**
 * ëª…ë ¹ì–´ ìƒì„¸ ì •ë³´ HTML ìƒì„±
 * @param commandName ëª…ë ¹ì–´ ì´ë¦„
 * @returns HTML ë¬¸ìì—´
 */
export async function generateCommandDetailHtml(commandName: string): Promise<string> {
  try {
    const commandData = await getCommandData(commandName);
    
    if (!commandData) {
      return getHelpPageHtml(`
        <div class="help-container">
          <h1>ëª…ë ¹ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</h1>
          <p>'${commandName}' ëª…ë ¹ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          <button class="back-button" onclick="executeCommand('help')">â† ëª¨ë“  ëª…ë ¹ì–´ ë³´ê¸°</button>
        </div>
      `);
    }
    
    // ëª…ë ¹ì–´ ì´ëª¨ì§€ ì•„ì´ì½˜ ì„ íƒ
    const commandIcon = getCommandIcon(commandData.name);
    
    let content = `
      <div class="help-container">
        <div class="command-detail">
          <div class="command-detail-header">
            <div class="command-detail-icon">${commandIcon}</div>
            <div class="command-detail-title">
              <h1>/${commandData.name}</h1>
              <div class="command-detail-category">${commandData.categoryName}</div>
            </div>
          </div>
          
          <div class="command-detail-description">
            ${commandData.longDescription || commandData.description}
          </div>
          
          <div class="command-detail-section">
            <h2>ì‚¬ìš©ë²•</h2>
            <div class="command-usage">
              <code>${commandData.usage || `/${commandData.name}`}</code>
              <button class="execute-button" onclick="executeCommand('${commandData.name}')">ì´ ëª…ë ¹ì–´ ì‹¤í–‰</button>
            </div>
          </div>
    `;
    
    // ì˜ˆì‹œ
    if (commandData.examples && commandData.examples.length > 0) {
      content += `
        <div class="command-detail-section">
          <h2>ì˜ˆì‹œ</h2>
          <div class="command-examples">
            ${commandData.examples.map((example: string) => `
              <div class="command-example">
                <code>${example}</code>
                <button class="example-execute-button" onclick="insertCommand('${example}')">
                  <span class="emoji-icon">âŒ¨ï¸</span>
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    // ë³„ì¹­
    if (commandData.aliases && commandData.aliases.length > 0) {
      content += `
        <div class="command-detail-section">
          <h2>ë³„ì¹­</h2>
          <div class="command-aliases-list">
            ${commandData.aliases.map((alias: string) => `
              <span class="command-alias" onclick="executeCommand('${alias}')">/${alias}</span>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    // ê´€ë ¨ ëª…ë ¹ì–´
    if (commandData.related && commandData.related.length > 0) {
      content += `
        <div class="command-detail-section">
          <h2>ê´€ë ¨ ëª…ë ¹ì–´</h2>
          <div class="related-commands">
            ${commandData.related.map((cmd: string) => `
              <div class="related-command" onclick="executeCommand('${cmd}')">
                <span class="related-command-icon">${getCommandIcon(cmd)}</span>
                <span class="related-command-name">/${cmd}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    content += `
          <div class="command-detail-actions">
            <button class="back-button" onclick="executeCommand('help')">â† ëª¨ë“  ëª…ë ¹ì–´ ë³´ê¸°</button>
          </div>
        </div>
      </div>
    `;
    
    return getHelpPageHtml(content);
  } catch (error) {
    console.error('ëª…ë ¹ì–´ ìƒì„¸ ì •ë³´ HTML ìƒì„± ì˜¤ë¥˜:', error);
    return getHelpPageHtml(`
      <div class="help-container">
        <h1>ëª…ë ¹ì–´ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜</h1>
        <p>ëª…ë ¹ì–´ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}</p>
        <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    `);
  }
}

/**
 * FAQ HTML ìƒì„±
 * @returns HTML ë¬¸ìì—´
 */
export async function generateFaqHtml(): Promise<string> {
  try {
    const helpData = await loadHelpData();
    const faqs = helpData.faq || [];
    
    let content = `
      <div class="help-container">
        <div class="help-header">
          <h1 class="help-title">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)</h1>
          <div class="title-separator"></div>
          <p class="help-subtitle">APE ì‚¬ìš© ì¤‘ ìì£¼ ë°œìƒí•˜ëŠ” ì§ˆë¬¸ê³¼ ë‹µë³€ì…ë‹ˆë‹¤.</p>
        </div>
        
        <div class="faq-list">
    `;
    
    for (const faq of faqs) {
      content += `
        <div class="faq-card">
          <div class="faq-question">${faq.question}</div>
          <div class="faq-answer">${faq.answer}</div>
        </div>
      `;
    }
    
    content += `
        </div>
        
        <div class="help-footer">
          <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      </div>
    `;
    
    return getHelpPageHtml(content);
  } catch (error) {
    console.error('FAQ HTML ìƒì„± ì˜¤ë¥˜:', error);
    return getHelpPageHtml(`
      <div class="help-container">
        <h1>FAQ ë¡œë“œ ì˜¤ë¥˜</h1>
        <p>FAQ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}</p>
        <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    `);
  }
}

/**
 * ê°€ì´ë“œ ë¬¸ì„œ HTML ìƒì„±
 * @param guideId ê°€ì´ë“œ ID
 * @returns HTML ë¬¸ìì—´
 */
export async function generateGuideHtml(guideId: string): Promise<string> {
  try {
    const helpData = await loadHelpData();
    const guides = helpData.guides || [];
    const guide = guides.find((g: any) => g.id === guideId);
    
    if (!guide) {
      return getHelpPageHtml(`
        <div class="help-container">
          <h1>ê°€ì´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</h1>
          <p>'${guideId}' ê°€ì´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          <button class="back-button" onclick="executeCommand('help guides')">â† ëª¨ë“  ê°€ì´ë“œ ë³´ê¸°</button>
        </div>
      `);
    }
    
    // ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ê·¸ëŒ€ë¡œ í‘œì‹œ
    const content = `
      <div class="help-container">
        <div class="help-header">
          <h1 class="help-title">${guide.title}</h1>
          <div class="title-separator"></div>
        </div>
        
        <div class="guide-content markdown-body">
          ${guide.content}
        </div>
        
        <div class="help-footer">
          <button class="back-button" onclick="executeCommand('help guides')">â† ëª¨ë“  ê°€ì´ë“œ ë³´ê¸°</button>
        </div>
      </div>
    `;
    
    return getHelpPageHtml(content);
  } catch (error) {
    console.error('ê°€ì´ë“œ HTML ìƒì„± ì˜¤ë¥˜:', error);
    return getHelpPageHtml(`
      <div class="help-container">
        <h1>ê°€ì´ë“œ ë¡œë“œ ì˜¤ë¥˜</h1>
        <p>ê°€ì´ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}</p>
        <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    `);
  }
}

/**
 * ëª¨ë“  ê°€ì´ë“œ ëª©ë¡ HTML ìƒì„±
 * @returns HTML ë¬¸ìì—´
 */
export async function generateGuidesListHtml(): Promise<string> {
  try {
    const helpData = await loadHelpData();
    const guides = helpData.guides || [];
    
    let content = `
      <div class="help-container">
        <div class="help-header">
          <h1 class="help-title">ê°€ì´ë“œ ë¬¸ì„œ</h1>
          <div class="title-separator"></div>
          <p class="help-subtitle">ì‚¬ìš© ê°€ëŠ¥í•œ ê°€ì´ë“œ ë¬¸ì„œ ëª©ë¡ì…ë‹ˆë‹¤.</p>
        </div>
        
        <div class="guides-grid">
    `;
    
    for (const guide of guides) {
      // ì²« ë²ˆì§¸ ì¤„ë§Œ ì¶”ì¶œí•˜ì—¬ ë¯¸ë¦¬ë³´ê¸°ë¡œ ì‚¬ìš©
      const preview = guide.content.split('\n').slice(1, 3).join(' ').replace(/^\s*#+\s*/, '').substring(0, 120);
      
      content += `
        <div class="guide-card" onclick="executeCommand('help guide ${guide.id}')">
          <div class="guide-icon">${getGuideIcon(guide.id)}</div>
          <div class="guide-title">${guide.title}</div>
          <div class="guide-preview">${preview}...</div>
          <div class="guide-read-more">ìì„¸íˆ ë³´ê¸° â†’</div>
        </div>
      `;
    }
    
    content += `
        </div>
        
        <div class="help-footer">
          <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      </div>
    `;
    
    return getHelpPageHtml(content);
  } catch (error) {
    console.error('ê°€ì´ë“œ ëª©ë¡ HTML ìƒì„± ì˜¤ë¥˜:', error);
    return getHelpPageHtml(`
      <div class="help-container">
        <h1>ê°€ì´ë“œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜</h1>
        <p>ê°€ì´ë“œ ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}</p>
        <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    `);
  }
}

/**
 * LLMì„ ì‚¬ìš©í•œ ìŠ¤ë§ˆíŠ¸ ë„ì›€ë§ ìƒì„±
 * @param query ì‚¬ìš©ì ì§ˆë¬¸
 * @param llmService LLM ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤
 * @returns HTML ë¬¸ìì—´
 */
export async function generateSmartHelpHtml(query: string, llmService: LLMService): Promise<string> {
  try {
    const helpData = await loadHelpData();
    
    // LLM í”„ë¡¬í”„íŠ¸ ìƒì„±
    const prompt = generateHelpSystemPrompt(helpData, query);
    
    // LLMì— ì§ˆë¬¸ ì „ì†¡
    const result = await llmService.getCompletion(prompt);
    
    if (!result.success || !result.data) {
      throw new Error(result.error?.message || 'LLM ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // ë§ˆí¬ë‹¤ìš´ ì‘ë‹µì„ HTMLë¡œ ë³€í™˜
    const markdownResponse = result.data;
    
    const content = `
      <div class="help-container">
        <div class="help-header">
          <h1 class="help-title">APE ë„ì›€ë§ ê²€ìƒ‰</h1>
          <div class="title-separator"></div>
          <div class="help-query">"${escapeHtml(query)}"ì— ëŒ€í•œ ê²°ê³¼</div>
        </div>
        
        <div class="smart-help-result markdown-body">
          ${markdownToHtml(markdownResponse)}
        </div>
        
        <div class="help-footer">
          <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      </div>
    `;
    
    return getHelpPageHtml(content);
  } catch (error) {
    console.error('ìŠ¤ë§ˆíŠ¸ ë„ì›€ë§ ìƒì„± ì˜¤ë¥˜:', error);
    return getHelpPageHtml(`
      <div class="help-container">
        <h1>ë„ì›€ë§ ì‘ë‹µ ì˜¤ë¥˜</h1>
        <p>ë„ì›€ë§ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}</p>
        <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    `);
  }
}

/**
 * Agent ë„êµ¬ ëª©ë¡ HTML ìƒì„±
 * @returns HTML ë¬¸ìì—´
 */
export async function generateToolsHelpHtml(): Promise<string> {
  try {
    // ë„êµ¬ ë°ì´í„° ëª©ë¡
    const tools = [
      {
        name: 'Bash',
        description: 'ì‰˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ íŒŒì¼ ì‹œìŠ¤í…œì„ ì¡°ì‘í•˜ê³  ì‹œìŠ¤í…œ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.',
        icon: 'âš™ï¸',
        examples: ['ë””ë ‰í„°ë¦¬ ë‚´ìš© ë‚˜ì—´', 'íŒŒì¼ ì´ë™ ë° ë³µì‚¬', 'ì‹œìŠ¤í…œ ì •ë³´ ì¡°íšŒ']
      },
      {
        name: 'Batch',
        description: 'ì—¬ëŸ¬ ë„êµ¬ í˜¸ì¶œì„ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ì—¬ ì‘ì—… ì†ë„ë¥¼ í–¥ìƒì‹œí‚µë‹ˆë‹¤.',
        icon: 'âš¡',
        examples: ['ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì½ê¸°', 'ë³µìˆ˜ Bash ëª…ë ¹ ì‹¤í–‰', 'ë³‘ë ¬ ê²€ìƒ‰ ìˆ˜í–‰']
      },
      {
        name: 'Glob',
        description: 'íŒ¨í„´ ë§¤ì¹­ì„ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ íŒŒì¼ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.',
        icon: 'ğŸ”',
        examples: ['.js íŒŒì¼ ì°¾ê¸°', 'íŠ¹ì • ë””ë ‰í„°ë¦¬ ë‚´ íŒŒì¼ ê²€ìƒ‰', 'ì œì™¸ íŒ¨í„´ ì‚¬ìš©']
      },
      {
        name: 'Grep',
        description: 'íŒŒì¼ ë‚´ìš©ì—ì„œ ì •ê·œì‹ íŒ¨í„´ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.',
        icon: 'ğŸ”',
        examples: ['í•¨ìˆ˜ ì •ì˜ ì°¾ê¸°', 'ì˜¤ë¥˜ ë©”ì‹œì§€ ê²€ìƒ‰', 'ì½”ë“œ íŒ¨í„´ ì‹ë³„']
      },
      {
        name: 'LS',
        description: 'ë””ë ‰í„°ë¦¬ ë‚´ìš©ì„ ë‚˜ì—´í•˜ì—¬ íŒŒì¼ê³¼ í´ë”ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.',
        icon: 'ğŸ“',
        examples: ['ë””ë ‰í„°ë¦¬ êµ¬ì¡° í™•ì¸', 'ìˆ¨ê²¨ì§„ íŒŒì¼ í‘œì‹œ', 'íŒŒì¼ ë©”íƒ€ë°ì´í„° í™•ì¸']
      },
      {
        name: 'Read',
        description: 'íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.',
        icon: 'ğŸ“–',
        examples: ['ì†ŒìŠ¤ ì½”ë“œ ì½ê¸°', 'êµ¬ì„± íŒŒì¼ ê²€ì‚¬', 'ë¡œê·¸ íŒŒì¼ ë¶„ì„']
      },
      {
        name: 'Edit',
        description: 'íŒŒì¼ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  ë³€ê²½ ì‚¬í•­ì„ ì €ì¥í•©ë‹ˆë‹¤.',
        icon: 'âœï¸',
        examples: ['ì½”ë“œ ë²„ê·¸ ìˆ˜ì •', 'êµ¬ì„± ì„¤ì • ì—…ë°ì´íŠ¸', 'ë¬¸ì„œ ìˆ˜ì •']
      },
      {
        name: 'MultiEdit',
        description: 'ì—¬ëŸ¬ í¸ì§‘ ì‘ì—…ì„ ë‹¨ì¼ íŒŒì¼ì— ì›ìì ìœ¼ë¡œ ì ìš©í•©ë‹ˆë‹¤.',
        icon: 'ğŸ“',
        examples: ['ì—¬ëŸ¬ ì½”ë“œ ì„¹ì…˜ ìˆ˜ì •', 'í´ë˜ìŠ¤/í•¨ìˆ˜ ì´ë¦„ ë³€ê²½', 'ì—¬ëŸ¬ ë²„ê·¸ í•œ ë²ˆì— ìˆ˜ì •']
      },
      {
        name: 'Write',
        description: 'ìƒˆ íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ íŒŒì¼ì„ ë®ì–´ì”ë‹ˆë‹¤.',
        icon: 'ğŸ“„',
        examples: ['ìƒˆ ì†ŒìŠ¤ íŒŒì¼ ìƒì„±', 'êµ¬ì„± íŒŒì¼ ì‘ì„±', 'ë¡œê·¸ íŒŒì¼ ìƒì„±']
      },
      {
        name: 'WebFetch',
        description: 'ì›¹ URLì—ì„œ ì½˜í…ì¸ ë¥¼ ê°€ì ¸ì™€ ë¶„ì„í•©ë‹ˆë‹¤.',
        icon: 'ğŸŒ',
        examples: ['API ë¬¸ì„œ ì½ê¸°', 'ì›¹ í˜ì´ì§€ ì½˜í…ì¸  ë¶„ì„', 'ì™¸ë¶€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°']
      },
      {
        name: 'WebSearch',
        description: 'ì¸í„°ë„·ì—ì„œ ìµœì‹  ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.',
        icon: 'ğŸ”',
        examples: ['ê¸°ìˆ  ë¬¸ì„œ ì°¾ê¸°', 'ì˜¤ë¥˜ ì†”ë£¨ì…˜ ê²€ìƒ‰', 'ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ë²• ê²€ìƒ‰']
      },
      {
        name: 'TodoRead',
        description: 'ì„¸ì…˜ì˜ í˜„ì¬ í•  ì¼ ëª©ë¡ì„ ì½ìŠµë‹ˆë‹¤.',
        icon: 'ğŸ“‹',
        examples: ['ì‘ì—… ì§„í–‰ ìƒí™© í™•ì¸', 'ë‚¨ì€ ì‘ì—… íŒŒì•…', 'ì‘ì—… ìš°ì„ ìˆœìœ„ í™•ì¸']
      },
      {
        name: 'TodoWrite',
        description: 'í•  ì¼ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•˜ê³  ì‘ì—… ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.',
        icon: 'âœ…',
        examples: ['ìƒˆ ì‘ì—… ì¶”ê°€', 'ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸', 'ì™„ë£Œëœ ì‘ì—… í‘œì‹œ']
      },
      {
        name: 'Task',
        description: 'í•˜ìœ„ ì—ì´ì „íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ë…ë¦½ì ì¸ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.',
        icon: 'ğŸ¤–',
        examples: ['ì½”ë“œë² ì´ìŠ¤ ê²€ìƒ‰', 'ë³µì¡í•œì˜ ì‘ì—… ìœ„ì„', 'ë°°ê²½ ë¶„ì„ ìˆ˜í–‰']
      }
    ];
    
    // HTML ìƒì„±
    let content = `
      <div class="help-container">
        <div class="help-header">
          <h1 class="help-title">APE ë„êµ¬ ëª©ë¡</h1>
          <div class="title-separator"></div>
          <p class="help-subtitle">APEì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ Agent ë„êµ¬ ëª©ë¡ì…ë‹ˆë‹¤.</p>
        </div>
        
        <div class="tools-grid">
    `;
    
    // ê° ë„êµ¬ë³„ ì¹´ë“œ ìƒì„±
    for (const tool of tools) {
      content += `
        <div class="tool-card">
          <div class="tool-header">
            <div class="tool-icon">${tool.icon}</div>
            <div class="tool-name">${tool.name}</div>
          </div>
          <div class="tool-description">${tool.description}</div>
          
          <div class="tool-examples">
            <div class="tool-examples-title">ì£¼ìš” ì‚¬ìš© ì‚¬ë¡€</div>
            <ul class="tool-examples-list">
              ${tool.examples.map(ex => `<li>${ex}</li>`).join('')}
            </ul>
          </div>
        </div>
      `;
    }
    
    content += `
        </div>
        
        <div class="help-footer">
          <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      </div>
    `;
    
    // ì „ì²´ HTML ìƒì„±
    return getHelpPageHtml(content);
  } catch (error) {
    console.error('Agent ë„êµ¬ HTML ìƒì„± ì˜¤ë¥˜:', error);
    return getHelpPageHtml(`
      <div class="help-container">
        <h1>ë„êµ¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜</h1>
        <p>ë„êµ¬ ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}</p>
        <button class="back-button" onclick="executeCommand('help')">â† ë„ì›€ë§ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    `);
  }
}

/**
 * ë„ì›€ë§ í˜ì´ì§€ HTML ë˜í•‘
 * @param content ë‚´ìš© HTML
 * @returns ì™„ì„±ëœ HTML ë¬¸ìì—´
 */
function getHelpPageHtml(content: string): string {
  const customCss = getHelpCustomCSS();
  
  return `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>APE ë„ì›€ë§</title>
      <link rel="stylesheet" href="${getCodiconCssUri().toString()}" />
      <link rel="stylesheet" href="${getChatApeCssUri().toString()}" />
      <link rel="stylesheet" href="${getChatApeButtonsCssUri().toString()}" />
      <link rel="stylesheet" href="${getWelcomeCssUri().toString()}" />
      <style>
        ${customCss}
      </style>
    </head>
    <body>
      <div class="help-page">
        ${content}
      </div>

      <script>
        const vscode = acquireVsCodeApi();
        
        // ëª…ë ¹ì–´ ì‹¤í–‰ í•¨ìˆ˜
        function executeCommand(command) {
          vscode.postMessage({
            type: 'command',
            command: command
          });
        }
        
        // ëª…ë ¹ì–´ ì…ë ¥ í•¨ìˆ˜ (ì±„íŒ…ì°½ì— ëª…ë ¹ì–´ ì‚½ì…)
        function insertCommand(command) {
          vscode.postMessage({
            type: 'insertCommand',
            command: command
          });
        }
        
        // ì¹´í…Œê³ ë¦¬ íƒ­ í´ë¦­ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
          // ì¹´í…Œê³ ë¦¬ íƒ­ í´ë¦­ ì´ë²¤íŠ¸
          document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              // íƒ­ í™œì„±í™”
              document.querySelectorAll('.category-tab').forEach(t => {
                t.classList.remove('active');
              });
              tab.classList.add('active');
              
              // ì»¨í…ì¸  í‘œì‹œ
              const categoryId = tab.dataset.category;
              document.querySelectorAll('.category-section').forEach(section => {
                section.style.display = 'none';
              });
              
              const targetSection = document.getElementById('category-' + categoryId);
              if (targetSection) {
                targetSection.style.display = 'block';
              }
            });
          });
          
          // ì²« ë²ˆì§¸ íƒ­ í™œì„±í™” (ê¸°ë³¸ê°’)
          const firstTab = document.querySelector('.category-tab');
          if (firstTab) {
            firstTab.click();
          }
        });
      </script>
    </body>
    </html>
  `;
}

/**
 * ë„ì›€ë§ í˜ì´ì§€ ì»¤ìŠ¤í…€ CSS
 */
function getHelpCustomCSS(): string {
  return `
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    body, html {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: var(--ape-font-sans);
      background-color: var(--ape-bg-primary);
      color: var(--ape-text-primary);
    }
    
    /* ë„ì›€ë§ í˜ì´ì§€ ì»¨í…Œì´ë„ˆ */
    .help-page {
      max-width: 1024px;
      margin: 0 auto;
      padding: 2rem;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
    }
    
    /* ë„ì›€ë§ ì»¨í…Œì´ë„ˆ */
    .help-container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
    }
    
    /* ë„ì›€ë§ í—¤ë” */
    .help-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .help-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--ape-text-primary);
      letter-spacing: -0.02em;
    }
    
    .title-separator {
      width: 60px;
      height: 3px;
      background-color: var(--ape-accent-primary);
      margin: 1rem auto;
    }
    
    .help-tagline {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0.5rem 0;
      color: var(--ape-accent-primary);
      letter-spacing: 0.05em;
    }
    
    .help-subtitle {
      font-size: 1rem;
      color: var(--ape-text-secondary);
      margin: 0.5rem 0 0;
    }
    
    .help-query {
      font-size: 1.2rem;
      margin: 1rem 0;
      padding: 0.5rem 1rem;
      background-color: var(--ape-accent-tertiary);
      border-radius: var(--ape-border-radius-md);
      display: inline-block;
    }
    
    /* ë¹ ë¥¸ ì•¡ì…˜ ì˜ì—­ */
    .quick-actions {
      margin: 1.5rem 0 2rem;
      background-color: var(--ape-bg-secondary);
      border-radius: var(--ape-border-radius-md);
      padding: 1.5rem;
      box-shadow: var(--ape-shadow-md);
    }
    
    .quick-actions h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      color: var(--ape-text-primary);
    }
    
    .quick-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .quick-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem 1.2rem;
      background-color: var(--ape-accent-primary);
      border: none;
      border-radius: var(--ape-border-radius-md);
      color: white;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--ape-shadow-sm);
      min-width: 160px;
      gap: 0.5rem;
    }
    
    .quick-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--ape-shadow-md);
    }
    
    .quick-button.git {
      background-color: #F05033;
    }
    
    .quick-button.code {
      background-color: #007ACC;
    }
    
    .quick-button.utility {
      background-color: #6C757D;
    }
    
    .quick-button.model {
      background-color: #28A745;
    }
    
    .quick-button .emoji-icon {
      font-size: 1.2rem;
    }
    
    /* ì¹´í…Œê³ ë¦¬ íƒ­ */
    .category-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--ape-border-subtle);
      padding-bottom: 1rem;
    }
    
    .category-tab {
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: var(--ape-border-radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: var(--ape-bg-secondary);
      border: 1px solid var(--ape-border-subtle);
    }
    
    .category-tab:hover {
      background-color: var(--ape-bg-hover);
      transform: translateY(-2px);
    }
    
    .category-tab.active {
      background-color: var(--ape-accent-tertiary);
      border-color: var(--ape-accent-primary);
      color: var(--ape-accent-primary);
      font-weight: 500;
    }
    
    .category-icon {
      font-size: 1.2rem;
    }
    
    /* ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ */
    .category-sections {
      margin-top: 1.5rem;
    }
    
    .category-section {
      display: none;
      margin-bottom: 2rem;
    }
    
    .category-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .category-section h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--ape-text-primary);
      border-bottom: 1px solid var(--ape-border-subtle);
      padding-bottom: 0.5rem;
    }
    
    .category-section p {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--ape-text-secondary);
    }
    
    /* ëª…ë ¹ì–´ ê·¸ë¦¬ë“œ */
    .command-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    
    /* ì¼ë°˜ ëª…ë ¹ì–´ ì¹´ë“œ */
    .command-card {
      background-color: var(--ape-bg-secondary);
      border-radius: var(--ape-border-radius-md);
      border: 1px solid var(--ape-border-subtle);
      padding: 1.2rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 1rem;
      box-shadow: var(--ape-shadow-sm);
    }
    
    .command-card:hover {
      transform: translateY(-3px);
      border-color: var(--ape-accent-primary);
      box-shadow: var(--ape-shadow-md);
    }
    
    .command-icon {
      font-size: 1.5rem;
      background-color: var(--ape-accent-tertiary);
      width: 40px;
      height: 40px;
      border-radius: var(--ape-border-radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .command-content {
      flex: 1;
    }
    
    .command-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      color: var(--ape-accent-primary);
      font-family: var(--ape-font-mono);
    }
    
    .command-description {
      color: var(--ape-text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    .command-aliases {
      font-size: 0.8rem;
      color: var(--ape-text-secondary);
      background-color: var(--ape-bg-tertiary);
      padding: 0.3rem 0.5rem;
      border-radius: var(--ape-border-radius-sm);
      display: inline-block;
    }
    
    /* Git ëª…ë ¹ì–´ ì¹´ë“œ (íŠ¹ë³„ ìŠ¤íƒ€ì¼) */
    .git-commands-container {
      margin-top: 1rem;
    }
    
    .git-commands-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    .git-command-card {
      background-color: var(--ape-bg-secondary);
      border-radius: var(--ape-border-radius-md);
      border: 1px solid #F05033;
      padding: 1.2rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      box-shadow: var(--ape-shadow-sm);
      position: relative;
      overflow: hidden;
    }
    
    .git-command-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background-color: #F05033;
      transition: width 0.3s ease;
      z-index: 1;
    }
    
    .git-command-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(240, 80, 51, 0.2);
    }
    
    .git-command-card:hover::before {
      width: 8px;
    }
    
    .git-command-header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      margin-bottom: 0.8rem;
    }
    
    .git-command-icon {
      font-size: 1.3rem;
      color: #F05033;
    }
    
    .git-command-name {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--ape-text-primary);
      font-family: var(--ape-font-mono);
    }
    
    .git-command-description {
      color: var(--ape-text-primary);
      margin-bottom: 1rem;
      font-size: 0.9rem;
      line-height: 1.4;
      flex: 1;
    }
    
    .git-command-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }
    
    .git-command-example {
      font-size: 0.8rem;
      color: var(--ape-text-secondary);
      flex: 1;
    }
    
    .git-command-button {
      background-color: #F05033;
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: var(--ape-border-radius-sm);
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .git-command-card:hover .git-command-button {
      background-color: #DA3906;
    }
    
    /* ëª…ë ¹ì–´ ìƒì„¸ í˜ì´ì§€ */
    .command-detail {
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--ape-bg-secondary);
      border-radius: var(--ape-border-radius-lg);
      padding: 2rem;
      box-shadow: var(--ape-shadow-md);
    }
    
    .command-detail-header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--ape-border-subtle);
    }
    
    .command-detail-icon {
      font-size: 2rem;
      background-color: var(--ape-accent-tertiary);
      width: 60px;
      height: 60px;
      border-radius: var(--ape-border-radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .command-detail-title {
      flex: 1;
    }
    
    .command-detail-title h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.8rem;
      color: var(--ape-text-primary);
      font-family: var(--ape-font-mono);
    }
    
    .command-detail-category {
      color: var(--ape-text-secondary);
      font-size: 1rem;
    }
    
    .command-detail-description {
      margin-bottom: 2rem;
      line-height: 1.6;
      font-size: 1.1rem;
    }
    
    .command-detail-section {
      margin-bottom: 2rem;
    }
    
    .command-detail-section h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--ape-text-primary);
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--ape-border-subtle);
    }
    
    .command-usage {
      background-color: var(--ape-bg-tertiary);
      padding: 1rem;
      border-radius: var(--ape-border-radius-md);
      font-family: var(--ape-font-mono);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .command-usage code {
      font-size: 1.1rem;
      color: var(--ape-accent-primary);
    }
    
    .execute-button {
      background-color: var(--ape-accent-primary);
      color: white;
      border: none;
      border-radius: var(--ape-border-radius-md);
      padding: 0.5rem 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .execute-button:hover {
      background-color: var(--ape-accent-secondary);
      transform: translateY(-2px);
    }
    
    .command-examples {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    
    .command-example {
      background-color: var(--ape-bg-tertiary);
      padding: 0.8rem 1rem;
      border-radius: var(--ape-border-radius-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .command-example code {
      font-family: var(--ape-font-mono);
      font-size: 1rem;
      color: var(--ape-accent-primary);
      flex: 1;
    }
    
    .example-execute-button {
      background-color: transparent;
      border: 1px solid var(--ape-border-subtle);
      color: var(--ape-text-secondary);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .example-execute-button:hover {
      background-color: var(--ape-bg-hover);
      color: var(--ape-text-primary);
      border-color: var(--ape-border-strong);
    }
    
    .command-aliases-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
    }
    
    .command-alias {
      background-color: var(--ape-bg-tertiary);
      padding: 0.5rem 0.8rem;
      border-radius: var(--ape-border-radius-md);
      font-family: var(--ape-font-mono);
      font-size: 0.9rem;
      color: var(--ape-text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .command-alias:hover {
      background-color: var(--ape-accent-tertiary);
      color: var(--ape-accent-primary);
      transform: translateY(-2px);
    }
    
    .related-commands {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .related-command {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: var(--ape-bg-tertiary);
      padding: 0.5rem 1rem;
      border-radius: var(--ape-border-radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .related-command:hover {
      background-color: var(--ape-accent-tertiary);
      color: var(--ape-accent-primary);
      transform: translateY(-2px);
    }
    
    .related-command-icon {
      font-size: 1.2rem;
    }
    
    .related-command-name {
      font-family: var(--ape-font-mono);
      font-size: 0.9rem;
    }
    
    .command-detail-actions {
      margin-top: 2rem;
      display: flex;
      justify-content: center;
    }
    
    /* FAQ ìŠ¤íƒ€ì¼ */
    .faq-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-top: 2rem;
    }
    
    .faq-card {
      background-color: var(--ape-bg-secondary);
      border-radius: var(--ape-border-radius-md);
      padding: 1.5rem;
      box-shadow: var(--ape-shadow-sm);
      transition: all 0.2s ease;
      border-left: 3px solid var(--ape-accent-primary);
    }
    
    .faq-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--ape-shadow-md);
    }
    
    .faq-question {
      font-weight: 600;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--ape-text-primary);
    }
    
    .faq-answer {
      line-height: 1.6;
      color: var(--ape-text-primary);
    }
    
    /* ê°€ì´ë“œ ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .guides-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    
    .guide-card {
      background-color: var(--ape-bg-secondary);
      border-radius: var(--ape-border-radius-md);
      padding: 1.5rem;
      box-shadow: var(--ape-shadow-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
      border: 1px solid var(--ape-border-subtle);
    }
    
    .guide-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--ape-shadow-md);
      border-color: var(--ape-accent-primary);
    }
    
    .guide-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: var(--ape-accent-primary);
    }
    
    .guide-title {
      font-weight: 600;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--ape-text-primary);
    }
    
    .guide-preview {
      color: var(--ape-text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 1.5rem;
      flex: 1;
    }
    
    .guide-read-more {
      color: var(--ape-accent-primary);
      font-weight: 500;
      font-size: 0.9rem;
      margin-top: auto;
    }
    
    .guide-card:hover .guide-read-more {
      text-decoration: underline;
    }
    
    /* ë„êµ¬ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    
    .tool-card {
      background-color: var(--ape-bg-secondary);
      border-radius: var(--ape-border-radius-md);
      padding: 1.5rem;
      box-shadow: var(--ape-shadow-sm);
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--ape-border-subtle);
    }
    
    .tool-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--ape-shadow-md);
      border-color: var(--ape-accent-primary);
    }
    
    .tool-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .tool-icon {
      font-size: 1.5rem;
      color: var(--ape-accent-primary);
      background-color: var(--ape-accent-tertiary);
      width: 40px;
      height: 40px;
      border-radius: var(--ape-border-radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tool-name {
      font-weight: 600;
      font-size: 1.2rem;
      color: var(--ape-text-primary);
    }
    
    .tool-description {
      color: var(--ape-text-primary);
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    
    .tool-examples {
      background-color: var(--ape-bg-tertiary);
      border-radius: var(--ape-border-radius-md);
      padding: 1rem;
    }
    
    .tool-examples-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      color: var(--ape-text-primary);
    }
    
    .tool-examples-list {
      padding-left: 1.2rem;
      margin: 0.5rem 0 0 0;
    }
    
    .tool-examples-list li {
      color: var(--ape-text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }
    
    /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
    .help-footer {
      margin-top: 2rem;
      display: flex;
      justify-content: center;
    }
    
    .back-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: var(--ape-bg-tertiary);
      border: 1px solid var(--ape-border-subtle);
      padding: 0.8rem 1.5rem;
      border-radius: var(--ape-border-radius-md);
      color: var(--ape-text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1rem;
    }
    
    .back-button:hover {
      background-color: var(--ape-bg-hover);
      transform: translateY(-2px);
      border-color: var(--ape-border-strong);
    }
    
    /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .markdown-body {
      line-height: 1.6;
    }
    
    .markdown-body h1, .markdown-body h2, .markdown-body h3 {
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      color: var(--ape-text-primary);
    }
    
    .markdown-body p {
      margin-bottom: 1rem;
    }
    
    .markdown-body ul, .markdown-body ol {
      margin-bottom: 1rem;
      padding-left: 1.5rem;
    }
    
    .markdown-body li {
      margin-bottom: 0.5rem;
    }
    
    .markdown-body code {
      background-color: var(--ape-bg-tertiary);
      padding: 0.2rem 0.4rem;
      border-radius: var(--ape-border-radius-sm);
      font-family: var(--ape-font-mono);
      font-size: 0.9em;
    }
    
    .markdown-body pre {
      background-color: var(--ape-bg-tertiary);
      padding: 1rem;
      border-radius: var(--ape-border-radius-md);
      overflow-x: auto;
      margin-bottom: 1rem;
    }
    
    .markdown-body pre code {
      background-color: transparent;
      padding: 0;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .help-page {
        padding: 1rem;
      }
      
      .command-detail {
        padding: 1.5rem;
      }
      
      .git-commands-grid, .command-grid, .guides-grid, .tools-grid {
        grid-template-columns: 1fr;
      }
      
      .quick-buttons {
        flex-direction: column;
      }
      
      .category-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        gap: 0.5rem;
      }
      
      .category-tab {
        flex: 0 0 auto;
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }
    }
  `;
}

/**
 * HTML ì´ìŠ¤ì¼€ì´í”„
 * @param unsafe ì´ìŠ¤ì¼€ì´í”„í•  ë¬¸ìì—´
 * @returns ì´ìŠ¤ì¼€ì´í”„ëœ ë¬¸ìì—´
 */
function escapeHtml(unsafe: string): string {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/**
 * ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
 * @param category ì¹´í…Œê³ ë¦¬ ID
 * @returns ì´ëª¨ì§€ ì•„ì´ì½˜
 */
function getCategoryEmoji(category: string): string {
  switch (category) {
    case 'general':
      return 'ğŸ“š';
    case 'git':
      return 'âš™ï¸';
    case 'code':
      return 'ğŸ”';
    case 'utility':
      return 'ğŸ§°';
    case 'advanced':
      return 'ğŸ”§';
    case 'model':
      return 'ğŸ¤–';
    default:
      return 'ğŸ“‹';
  }
}

/**
 * ëª…ë ¹ì–´ë³„ ì´ëª¨ì§€ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
 * @param command ëª…ë ¹ì–´ ì´ë¦„
 * @returns ì´ëª¨ì§€ ì•„ì´ì½˜
 */
function getCommandIcon(command: string): string {
  // ëª…ë ¹ì–´ì— ë”°ë¼ ì ì ˆí•œ ì´ëª¨ì§€ ë°˜í™˜
  if (command.includes('git')) {
    if (command.includes('status')) return 'ğŸ“Š';
    if (command.includes('commit')) return 'ğŸ’¾';
    if (command.includes('auto')) return 'ğŸ”„';
    if (command.includes('consolidate') || command.includes('squash')) return 'ğŸ“¦';
    if (command.includes('branch')) return 'ğŸŒ¿';
    if (command.includes('push')) return 'ğŸ“¤';
    if (command.includes('pull')) return 'ğŸ“¥';
    if (command.includes('solve')) return 'ğŸ”§';
    return 'âš™ï¸';
  }
  
  switch (command) {
    // ì¼ë°˜ ëª…ë ¹ì–´
    case 'help': return 'â“';
    case 'clear': return 'ğŸ§¹';
    
    // ì½”ë“œ ê´€ë ¨
    case 'analyze': return 'ğŸ”';
    case 'code': return 'ğŸ“„';
    
    // ëª¨ë¸ ê´€ë ¨
    case 'model': return 'ğŸ¤–';
    case 'model list': return 'ğŸ“‹';
    case 'model use': return 'ğŸ”„';
    
    // ìœ í‹¸ë¦¬í‹° ëª…ë ¹ì–´
    case 'settings': return 'âš™ï¸';
    case 'open': return 'ğŸ“‚';
    case 'chat': return 'ğŸ’¬';
    case 'chat save': return 'ğŸ’¾';
    case 'chat list': return 'ğŸ“‹';
    case 'chat show': return 'ğŸ‘ï¸';
    
    // ì‚¬ìš©ì í™•ì¥ ëª…ë ¹ì–´
    case 'plugins': return 'ğŸ§©';
    case 'rules': return 'ğŸ“';
    case 'vault': return 'ğŸ”’';
    
    // ê¸°ë³¸ê°’
    default: return 'ğŸ“';
  }
}

/**
 * ê°€ì´ë“œë³„ ì´ëª¨ì§€ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
 * @param guideId ê°€ì´ë“œ ID
 * @returns ì´ëª¨ì§€ ì•„ì´ì½˜
 */
function getGuideIcon(guideId: string): string {
  switch (guideId) {
    case 'auto-commit':
      return 'âš™ï¸';
    case 'code-analysis':
      return 'ğŸ”';
    case 'git-integration':
      return 'ğŸ”„';
    case 'slash-commands':
      return 'ğŸ“š';
    case 'plugins':
      return 'ğŸ§©';
    default:
      return 'ğŸ“–';
  }
}

/**
 * ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ (ê°„ë‹¨ êµ¬í˜„)
 */
function markdownToHtml(markdown: string): string {
  return markdown
    // í—¤ë” ë³€í™˜
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
    .replace(/^##### (.+)$/gm, '<h5>$1</h5>')
    .replace(/^###### (.+)$/gm, '<h6>$1</h6>')

    // ì½”ë“œ ë¸”ë¡ ë³€í™˜
    .replace(/```([a-z]*)\n([\s\S]*?)\n```/g, '<pre><code class="language-$1">$2</code></pre>')

    // ì¸ë¼ì¸ ì½”ë“œ ë³€í™˜
    .replace(/`([^`]+)`/g, '<code>$1</code>')

    // ë³¼ë“œ í…ìŠ¤íŠ¸ ë³€í™˜
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/__([^_]+)__/g, '<strong>$1</strong>')

    // ì´íƒ¤ë¦­ í…ìŠ¤íŠ¸ ë³€í™˜
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/_([^_]+)_/g, '<em>$1</em>')

    // ëª©ë¡ ë³€í™˜
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^([0-9]+)\. (.+)$/gm, '<li>$2</li>')
    .replace(/(<li>.*<\/li>\n)+/g, '<ul>$&</ul>')

    // ë§í¬ ë³€í™˜
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')

    // ì¤„ë°”ê¿ˆ ë³€í™˜
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>')

    // ë‹¨ë½ ê°ì‹¸ê¸°
    .replace(/^(.+?)(?=<\/p>|<h[1-6]|<ul>|$)/s, '<p>$1</p>');
}