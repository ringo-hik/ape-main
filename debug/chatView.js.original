/**
 * ì±„íŒ… ë·° ì¸í„°í˜ì´ìŠ¤ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
 * CSP ìˆœí™˜ ì°¸ì¡° ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë¶„ë¦¬
 */
(function() {
  // ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
  const { vscode, dom, format, debounce } = window.apeUtils;
  
  // ìƒíƒœ ê´€ë¦¬
  let state = {
    messages: [],
    isStreaming: false,
    activeSuggestionIndex: -1,
    suggestions: [],
    attachedFiles: [],
    isUserScrolled: false,
    isScrollNearBottom: true,
    SCROLL_THRESHOLD: 100
  };
  
  // DOM ìš”ì†Œ
  let elements = {
    chatMessages: null,
    chatInput: null,
    sendButton: null,
    clearButton: null,
    attachButton: null,
    modelIndicator: null,
    modelSelector: null,
    commandSuggestionsContainer: null
  };
  
  // ì´ˆê¸°í™” í•¨ìˆ˜
  function initialize() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setup);
    } else {
      setup();
    }
  }
  
  // ì„¤ì • í•¨ìˆ˜
  function setup() {
    console.log("Initializing chat interface...");
    
    // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    elements.chatMessages = dom.getElement('#chat-messages');
    elements.chatInput = dom.getElement('#chat-input');
    elements.sendButton = dom.getElement('#send-button');
    elements.clearButton = dom.getElement('#clear-button');
    elements.attachButton = dom.getElement('#attach-button');
    elements.modelIndicator = dom.getElement('#model-name');
    elements.modelSelector = dom.getElement('#model-selector');
    elements.commandSuggestionsContainer = dom.getElement('#command-suggestions');
    
    // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if (!elements.chatMessages || !elements.chatInput || !elements.sendButton || !elements.clearButton) {
      console.error('Critical UI elements missing');
      setTimeout(setup, 500);
      return;
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupEventListeners();
    
    // ì´ˆê¸° ë©”ì‹œì§€ ì„¤ì •
    const initialState = vscode.getState();
    if (initialState && initialState.messages) {
      updateMessages(initialState.messages, initialState.isStreaming || false);
    }
    
    // ì…ë ¥ì°½ ì´ˆê¸° í¬ê¸° ì¡°ì •
    resizeInput();
    
    // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
    setTimeout(() => {
      if (elements.chatInput) {
        elements.chatInput.focus();
      }
    }, 100);
    
    console.log('Chat interface initialized successfully');
  }
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  function setupEventListeners() {
    // ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ê°ì§€
    elements.chatMessages.addEventListener('scroll', detectUserScroll);
    
    // ì…ë ¥ì°½ ì´ë²¤íŠ¸
    elements.chatInput.addEventListener('input', () => {
      resizeInput();
      notifyInputChanged();
    });
    
    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    elements.chatInput.addEventListener('keydown', handleKeyDown);
    
    // ë²„íŠ¼ ì´ë²¤íŠ¸
    elements.sendButton.addEventListener('click', handleSendClick);
    elements.clearButton.addEventListener('click', handleClearClick);
    
    if (elements.attachButton) {
      elements.attachButton.addEventListener('click', () => {
        vscode.postMessage({ type: 'attachFile' });
      });
    }
    
    if (elements.modelSelector) {
      elements.modelSelector.addEventListener('click', () => {
        vscode.postMessage({ type: 'showModelSelector' });
      });
    }
    
    // ë©”ì‹œì§€ ì˜ì—­ í´ë¦­ ì´ë²¤íŠ¸ (ì½”ë“œ ë¸”ë¡ ë“±)
    elements.chatMessages.addEventListener('click', handleChatMessagesClick);
    
    // VSCode ë©”ì‹œì§€ ì²˜ë¦¬
    window.addEventListener('message', handleVSCodeMessage);
  }
  
  // VSCode ë©”ì‹œì§€ ì²˜ë¦¬
  function handleVSCodeMessage(event) {
    const message = event.data;

    switch (message.type) {
      case 'updateMessages':
        // Enhanced message handling with additional properties
        updateMessages(
          message.messages,
          message.isStreaming,
          message.forceUpdate || false,
          message.timestamp
        );
        break;

      case 'editorContent':
        handleEditorContent(message.content);
        break;

      case 'commandSuggestions':
        updateCommandSuggestions(message.suggestions);
        break;

      case 'insertCommandToInput':
        insertCommandFromHelp(message.command);
        break;

      case 'updateModelIndicator':
        updateModelName(message.modelName);
        break;

      case 'fileAttached':
        handleFileAttachment(message.file);
        break;

      case 'updateSmartPrompting':
        updateSmartPromptingUI(message.enabled, message.mode);
        break;
    }
  }
  
  // ìŠ¤ë§ˆíŠ¸ í”„ë¡¬í”„íŒ… UI ì—…ë°ì´íŠ¸
  function updateSmartPromptingUI(enabled, mode) {
    const smartPromptingToggle = dom.getElement('#smart-prompting-toggle');
    const smartPromptingLabel = dom.getElement('#smart-prompting-label');
    
    if (!smartPromptingToggle || !smartPromptingLabel) return;
    
    if (enabled) {
      smartPromptingToggle.classList.add('active');
      
      let modeText = 'ìŠ¤ë§ˆíŠ¸ í”„ë¡¬í”„íŒ…';
      switch (mode) {
        case 'basic':
          modeText = 'ê¸°ë³¸ ëª¨ë“œ';
          break;
        case 'advanced':
          modeText = 'ê³ ê¸‰ ëª¨ë“œ';
          break;
        case 'expert':
          modeText = 'ì „ë¬¸ê°€ ëª¨ë“œ';
          break;
      }
      
      smartPromptingLabel.textContent = modeText;
    } else {
      smartPromptingToggle.classList.remove('active');
      smartPromptingLabel.textContent = 'ìŠ¤ë§ˆíŠ¸ í”„ë¡¬í”„íŒ…';
    }
  }
  
  // ëª¨ë¸ëª… ì—…ë°ì´íŠ¸
  function updateModelName(modelName) {
    if (!elements.modelIndicator || !modelName) return;
    
    elements.modelIndicator.textContent = modelName;
  }
  
  // ì—ë””í„° ì½˜í…ì¸  ì²˜ë¦¬
  function handleEditorContent(content) {
    if (!elements.chatInput || !content) return;
    
    elements.chatInput.value += '```\n' + content + '\n```\n';
    resizeInput();
  }
  
  // íŒŒì¼ ì²¨ë¶€ ì²˜ë¦¬
  function handleFileAttachment(file) {
    if (!elements.chatInput || !file) return;
    
    // ì²¨ë¶€ íŒŒì¼ ëª©ë¡ì— ì¶”ê°€
    state.attachedFiles.push({
      path: file.relativePath || file.path,
      name: file.name,
      type: file.type,
      content: file.hasContent ? file.content : undefined
    });
    
    // ì…ë ¥ì°½ì— ì²¨ë¶€ íŒŒì¼ ì •ë³´ ì¶”ê°€
    const fileName = file.name;
    const fileInfo = "ì²¨ë¶€ëœ íŒŒì¼: " + fileName;
    
    if (elements.chatInput.value) {
      elements.chatInput.value += '\n' + fileInfo;
    } else {
      elements.chatInput.value = fileInfo;
    }
    
    resizeInput();
    elements.chatInput.focus();
  }
  
  // í—¬í”„ì—ì„œ ëª…ë ¹ì–´ ì‚½ì…
  function insertCommandFromHelp(command) {
    if (!elements.chatInput) return;
    
    // ìŠ¬ë˜ì‹œê°€ ì—†ëŠ” ê²½ìš° ì¶”ê°€
    if (!command.startsWith('/')) {
      command = '/' + command;
    }
    
    // ì±„íŒ… ì…ë ¥ì°½ì— ëª…ë ¹ì–´ ì…ë ¥
    elements.chatInput.value = command;
    elements.chatInput.focus();
    
    // ì»¤ì„œë¥¼ ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ë™
    elements.chatInput.selectionStart = elements.chatInput.selectionEnd = elements.chatInput.value.length;
    
    // ì…ë ¥ì°½ í¬ê¸° ì¡°ì •
    resizeInput();
    
    // ì…ë ¥ ë³€ê²½ í•„ìš”
    notifyInputChanged();
  }
  
  // ë©”ì‹œì§€ ì „ì†¡ í´ë¦­ ì²˜ë¦¬
  function handleSendClick() {
    if (elements.chatInput.disabled) {
      // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì´ë©´ ì·¨ì†Œ ìš”ì²­
      vscode.postMessage({ type: 'cancelStream' });
    } else {
      // ì¼ë°˜ ë©”ì‹œì§€ ì „ì†¡
      sendMessage();
    }
  }
  
  // ì´ˆê¸°í™” í´ë¦­ ì²˜ë¦¬
  function handleClearClick() {
    vscode.postMessage({ type: 'clearChat' });
  }
  
  // ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ í´ë¦­ ì²˜ë¦¬
  function handleChatMessagesClick(event) {
    // ì½”ë“œ ë¸”ë¡ ë™ì‘ ì²˜ë¦¬
    const target = event.target;
    
    // ë³µì‚¬ ë²„íŠ¼ ì²˜ë¦¬
    if (target.closest('.copy-button')) {
      const button = target.closest('.copy-button');
      const codeId = button.getAttribute('data-code-id');
      const codeElement = document.getElementById('code-' + codeId);
      
      if (codeElement) {
        vscode.postMessage({
          type: 'copyCode',
          code: codeElement.textContent
        });
        
        // ë³µì‚¬ í”¼ë“œë°± í‘œì‹œ
        button.classList.add('copied');
        setTimeout(() => {
          button.classList.remove('copied');
        }, 2000);
      }
    }
    
    // ì‚½ì… ë²„íŠ¼ ì²˜ë¦¬
    if (target.closest('.insert-code-button')) {
      const button = target.closest('.insert-code-button');
      const codeId = button.getAttribute('data-code-id');
      const codeElement = document.getElementById('code-' + codeId);
      
      if (codeElement) {
        vscode.postMessage({
          type: 'insertCodeToEditor',
          code: codeElement.textContent
        });
      }
    }
    
    // ìƒˆ íŒŒì¼ ë²„íŠ¼ ì²˜ë¦¬
    if (target.closest('.new-file-button')) {
      const button = target.closest('.new-file-button');
      const codeId = button.getAttribute('data-code-id');
      const codeElement = document.getElementById('code-' + codeId);
      const languageElement = button.closest('.code-block-container').querySelector('.code-block-language');
      
      if (codeElement) {
        const language = languageElement ?
          languageElement.textContent.trim() || 'plaintext' :
          'plaintext';
        
        vscode.postMessage({
          type: 'createFileWithCode',
          code: codeElement.textContent,
          language: language
        });
      }
    }
    
    // ì²¨ë¶€ íŒŒì¼ ë·° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
    if (target.closest('.attachment-action.view-file')) {
      const attachedFile = target.closest('.attached-file');
      if (attachedFile) {
        const fileName = attachedFile.querySelector('.attachment-name').textContent;
        // VS Codeì— íŒŒì¼ ì—´ê¸° ìš”ì²­
        vscode.postMessage({
          type: 'openFile',
          fileName: fileName
        });
      }
    }
  }
  
  // í‚¤ë³´ë“œ ì…ë ¥ ì²˜ë¦¬
  function handleKeyDown(e) {
    // ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ì œì•ˆ ëª©ë¡ì´ ìˆëŠ” ê²½ìš°
    if (state.suggestions.length > 0) {
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateSuggestion('up');
        return;
      } 
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateSuggestion('down');
        return;
      }
      
      if (e.key === 'Tab') {
        e.preventDefault();
        selectActiveSuggestion();
        return;
      }
      
      if (e.key === 'Enter' && state.activeSuggestionIndex >= 0) {
        e.preventDefault();
        selectSuggestion(state.activeSuggestionIndex);
        
        // ë‹¨ë… ì‹¤í–‰ ê°€ëŠ¥í•œ ëª…ë ¹ì–´ì¸ ê²½ìš° ìë™ ì‹¤í–‰
        if (state.activeSuggestionIndex >= 0 && state.activeSuggestionIndex < state.suggestions.length) {
          const suggestion = state.suggestions[state.activeSuggestionIndex];
          if (isStandAloneCommand(suggestion.insertText)) {
            sendMessage();
          }
        }
        return;
      }
      
      if (e.key === 'Escape') {
        e.preventDefault();
        hideCommandSuggestions();
        return;
      }
    }
    
    // ì¼ë°˜ ì—”í„° í‚¤ ì²˜ë¦¬ (ë©”ì‹œì§€ ì „ì†¡)
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }
  
  // ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ë„¤ë¹„ê²Œì´ì…˜
  function navigateSuggestion(direction) {
    if (state.suggestions.length === 0) return false;
    
    // ì²˜ìŒ ë°©í–¥í‚¤ë¥¼ ëˆ„ë¥´ë©´ 0ë²ˆ í•­ëª© ì„ íƒ
    if (state.activeSuggestionIndex === -1) {
      state.activeSuggestionIndex = 0;
      highlightActiveSuggestion();
      return true;
    }
    
    // ë°©í–¥ì— ë”°ë¼ ì¸ë±ìŠ¤ ì¡°ì •
    if (direction === 'up') {
      state.activeSuggestionIndex = state.activeSuggestionIndex <= 0 ?
        state.suggestions.length - 1 : state.activeSuggestionIndex - 1;
    } else {
      state.activeSuggestionIndex = state.activeSuggestionIndex >= state.suggestions.length - 1 ?
        0 : state.activeSuggestionIndex + 1;
    }
    
    highlightActiveSuggestion();
    return true;
  }
  
  // í™œì„±í™”ëœ ì œì•ˆ í•­ëª© ê°•ì¡°
  function highlightActiveSuggestion() {
    if (!elements.commandSuggestionsContainer) return;
    
    // ëª¨ë“  í•­ëª©ì—ì„œ í™œì„± í´ë˜ìŠ¤ ì œê±°
    dom.getElements('.command-suggestion').forEach(el => {
      el.classList.remove('active');
    });
    
    // í˜„ì¬ í™œì„± í•­ëª©ì— í´ë˜ìŠ¤ ì¶”ê°€
    if (state.activeSuggestionIndex >= 0 && state.activeSuggestionIndex < state.suggestions.length) {
      const activeElement = dom.getElement(
        `.command-suggestion[data-index="${state.activeSuggestionIndex}"]`
      );
      
      if (activeElement) {
        activeElement.classList.add('active');
        
        // ìŠ¤í¬ë¡¤ ì˜ì—­ ë‚´ë¡œ í‘œì‹œ
        const container = elements.commandSuggestionsContainer;
        const elementTop = activeElement.offsetTop;
        const elementBottom = elementTop + activeElement.offsetHeight;
        const containerTop = container.scrollTop;
        const containerBottom = containerTop + container.offsetHeight;
        
        if (elementTop < containerTop) {
          container.scrollTop = elementTop;
        } else if (elementBottom > containerBottom) {
          container.scrollTop = elementBottom - container.offsetHeight;
        }
      }
    }
  }
  
  // í™œì„±í™”ëœ ì œì•ˆ ì„ íƒ
  function selectActiveSuggestion() {
    if (state.activeSuggestionIndex >= 0 && state.activeSuggestionIndex < state.suggestions.length) {
      selectSuggestion(state.activeSuggestionIndex);
    } else if (state.suggestions.length > 0) {
      state.activeSuggestionIndex = 0;
      highlightActiveSuggestion();
    }
  }
  
  // íŠ¹ì • ì¸ë±ìŠ¤ì˜ ì œì•ˆ ì„ íƒ
  function selectSuggestion(index) {
    if (index < 0 || index >= state.suggestions.length || !elements.chatInput) return;
    
    const suggestion = state.suggestions[index];
    
    // ì…ë ¥ì°½ì— ì œì•ˆ í…ìŠ¤íŠ¸ ì‚½ì…
    elements.chatInput.value = suggestion.insertText;
    elements.chatInput.focus();
    
    // ì»¤ì„œë¥¼ ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ë™
    elements.chatInput.selectionStart = elements.chatInput.selectionEnd = elements.chatInput.value.length;
    
    // ì…ë ¥ì°½ í¬ê¸° ì¡°ì •
    resizeInput();
    
    // ì œì•ˆ ëª©ë¡ ìˆ¨ê¹€
    hideCommandSuggestions();
    
    // ì…ë ¥ ë³€ê²½ ì•Œë¦¼
    notifyInputChanged();
  }
  
  // ì œì•ˆ ëª©ë¡ ìˆ¨ê¹€
  function hideCommandSuggestions() {
    if (!elements.commandSuggestionsContainer) return;
    
    elements.commandSuggestionsContainer.style.display = 'none';
    state.suggestions = [];
    state.activeSuggestionIndex = -1;
  }
  
  // ì œì•ˆ ëª©ë¡ ì—…ë°ì´íŠ¸
  function updateCommandSuggestions(newSuggestions) {
    state.suggestions = newSuggestions || [];
    state.activeSuggestionIndex = -1;
    
    if (!elements.commandSuggestionsContainer) return;
    
    // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
    elements.commandSuggestionsContainer.innerHTML = '';
    
    // ì œì•ˆì´ ì—†ìœ¼ë©´ ìˆ¨ê¹€
    if (state.suggestions.length === 0) {
      elements.commandSuggestionsContainer.style.display = 'none';
      return;
    }
    
    // ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ì„¤ì •
    positionCommandSuggestions();
    
    // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í™”
    const categorizedSuggestions = {};
    state.suggestions.forEach(suggestion => {
      if (!categorizedSuggestions[suggestion.category]) {
        categorizedSuggestions[suggestion.category] = [];
      }
      categorizedSuggestions[suggestion.category].push(suggestion);
    });
    
    // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì œì•ˆ í•­ëª© ì¶”ê°€
    Object.keys(categorizedSuggestions).forEach(category => {
      // ì¹´í…Œê³ ë¦¬ í—¤ë” ì¶”ê°€
      const categoryHeader = dom.createElement('div', {
        className: 'suggestion-category',
        textContent: getCategoryTitle(category)
      });
      elements.commandSuggestionsContainer.appendChild(categoryHeader);
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì œì•ˆ í•­ëª© ì¶”ê°€
      categorizedSuggestions[category].forEach((suggestion) => {
        const suggestionIndex = state.suggestions.findIndex(s => s.label === suggestion.label);
        
        const suggestionElement = dom.createElement('div', {
          className: 'command-suggestion',
          dataset: {
            index: String(suggestionIndex),
            category: suggestion.category
          },
          onClick: () => selectSuggestion(suggestionIndex)
        }, [
          dom.createElement('span', {
            className: 'suggestion-icon',
            textContent: getSvgIconForCategory(suggestion.category)
          }),
          dom.createElement('span', {
            className: 'suggestion-label',
            textContent: suggestion.label
          }),
          dom.createElement('span', {
            className: 'suggestion-description',
            textContent: suggestion.description
          })
        ]);
        
        // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ê°•ì¡°
        suggestionElement.addEventListener('mouseover', () => {
          state.activeSuggestionIndex = suggestionIndex;
          highlightActiveSuggestion();
        });
        
        elements.commandSuggestionsContainer.appendChild(suggestionElement);
      });
    });
    
    // ì»¨í…Œì´ë„ˆ í‘œì‹œ
    elements.commandSuggestionsContainer.style.display = 'block';
  }
  
  // ì œì•ˆ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ì¡°ì •
  function positionCommandSuggestions() {
    if (!elements.chatInput || !elements.commandSuggestionsContainer) return;
    
    const inputContainer = dom.getElement('#chat-input-container');
    if (!inputContainer) return;
    
    const inputRect = inputContainer.getBoundingClientRect();
    
    // ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ì„¤ì •
    elements.commandSuggestionsContainer.style.position = 'absolute';
    elements.commandSuggestionsContainer.style.bottom = (inputRect.height + 8) + 'px';
    elements.commandSuggestionsContainer.style.left = '12px';
    elements.commandSuggestionsContainer.style.right = '12px';
    elements.commandSuggestionsContainer.style.zIndex = '1000';
  }
  
  // ì¹´í…Œê³ ë¦¬ ì œëª© ë³€í™˜
  function getCategoryTitle(category) {
    const titles = {
      'general': 'ì¼ë°˜ ëª…ë ¹ì–´',
      'git': 'Git ê´€ë ¨ ëª…ë ¹ì–´',
      'code': 'ì½”ë“œ ê´€ë ¨ ëª…ë ¹ì–´',
      'utility': 'ìœ í‹¸ë¦¬í‹° ëª…ë ¹ì–´',
      'advanced': 'ê³ ê¸‰ ëª…ë ¹ì–´'
    };
    
    return titles[category] || category;
  }
  
  // ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´ì½˜ ë°˜í™˜
  function getSvgIconForCategory(category) {
    const icons = {
      'general': 'â—',  // ì¼ë°˜ ëª…ë ¹ì–´
      'git': 'â—†',      // Git ëª…ë ¹ì–´
      'code': 'â–¢',     // ì½”ë“œ ê´€ë ¨
      'utility': 'â—ˆ',  // ìœ í‹¸ë¦¬í‹°
      'advanced': 'â—'  // ê³ ê¸‰ ì„¤ì •
    };
    
    return icons[category] || 'â—‹';
  }
  
  // ë‹¨ë… ì‹¤í–‰ ê°€ëŠ¥ ëª…ë ¹ì–´ í™•ì¸
  function isStandAloneCommand(commandText) {
    if (!commandText.startsWith('/')) return false;
    
    const commandParts = commandText.substring(1).split(/ +/);
    const baseCommand = commandParts[0];
    
    // ë‹¨ë… ì‹¤í–‰ ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡
    const standAloneCommands = ['help', 'clear', 'settings', 'model'];
    
    return standAloneCommands.includes(baseCommand) && commandParts.length === 1;
  }
  
  // ì…ë ¥ ë³€ê²½ ì•Œë¦¼
  function notifyInputChanged() {
    if (!elements.chatInput) return;
    
    vscode.postMessage({
      type: 'inputChanged',
      content: elements.chatInput.value
    });
  }
  
  // ë©”ì‹œì§€ ì „ì†¡
  function sendMessage() {
    if (!elements.chatInput) return;
    
    const content = elements.chatInput.value.trim();
    if (!content) return;
    
    // ì²¨ë¶€ íŒŒì¼ì´ ìˆëŠ” ê²½ìš° ë©”íƒ€ë°ì´í„° ì¶”ê°€
    if (state.attachedFiles.length > 0) {
      vscode.postMessage({
        type: 'sendMessage',
        content,
        metadata: {
          attachedFiles: state.attachedFiles
        }
      });
      
      // ì²¨ë¶€ íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
      state.attachedFiles = [];
    } else {
      vscode.postMessage({ type: 'sendMessage', content });
    }
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    elements.chatInput.value = '';
    resizeInput();
    
    // ëª…ë ¹ì–´ ì œì•ˆ ìˆ¨ê¹€
    hideCommandSuggestions();
  }
  
  // ì±„íŒ… ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
  function updateMessages(messages, isStreaming) {
    console.log(`[updateMessages] ë¦¬ì‹œë¸Œ: ë©”ì‹œì§€ ${messages.length}ê°œ, ìŠ¤íŠ¸ë¦¬ë°: ${isStreaming}`);
    if (!elements.chatMessages) return;
    
    // ìƒíƒœ ì €ì¥
    state.messages = messages;
    state.isStreaming = isStreaming;
    vscode.setState({ messages, isStreaming });
    
    // í˜„ì¬ ë©”ì‹œì§€ ID ëª©ë¡
    const currentMessageIds = Array.from(elements.chatMessages.children)
      .filter(el => el.classList.contains('message'))
      .map(el => el.getAttribute('data-message-id'))
      .filter(id => id);
    
    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ í™•ì¸
    detectUserScroll();
    
    // íƒ€ì„ìŠ¤íƒ¬í”„ ê·¸ë£¹ ì¶”ê°€
    const messagesWithTimestamps = addTimestampDividers(messages);
    
    // í˜„ì¬ í‘œì‹œí•  ë©”ì‹œì§€ ID ëª©ë¡
    const shouldContainIds = messagesWithTimestamps.map(m => m.id);
    
    // íƒ€ì…ì„ ì¸ë””ì¼€ì´í„° ì²˜ë¦¬
    if (isStreaming) {
      if (!document.querySelector('.typing-indicator')) {
        const typingIndicator = dom.createElement('div', {
          className: 'typing-indicator'
        }, [
          dom.createElement('span', { className: 'typing-dot' }),
          dom.createElement('span', { className: 'typing-dot' }),
          dom.createElement('span', { className: 'typing-dot' })
        ]);
        
        elements.chatMessages.appendChild(typingIndicator);
      }
    } else {
      // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±° (requestAnimationFrame ì‚¬ìš©)
      const typingIndicator = document.querySelector('.typing-indicator');
      if (typingIndicator) {
        requestAnimationFrame(() => {
          typingIndicator.remove();
        });
      }
    }
    
    // ë” ì´ìƒ í‘œì‹œí•  í•„ìš” ì—†ëŠ” ìš”ì†Œ ì œê±°
    Array.from(elements.chatMessages.children).forEach(el => {
      const id = el.getAttribute('data-message-id');
      if (!el.classList.contains('typing-indicator') && (!id || !shouldContainIds.includes(id))) {
        el.remove();
      }
    });
    
    // ê¸°ì¡´ íƒ€ì„ìŠ¤íƒ¬í”„ êµ¬ë¶„ì„  ì œê±°
    Array.from(elements.chatMessages.querySelectorAll('.timestamp-divider')).forEach(el => {
      el.remove();
    });
    
    // ê¸°ì¡´ ìš”ì†Œ ë§µ ìƒì„±
    const elementMap = {};
    Array.from(elements.chatMessages.children).forEach(el => {
      const id = el.getAttribute('data-message-id');
      if (id) {
        elementMap[id] = el;
      }
    });
    
    // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ ë° ì¶”ê°€
    let previousElement = null;
    messagesWithTimestamps.forEach((item, index) => {
      // íƒ€ì„ìŠ¤íƒ¬í”„ êµ¬ë¶„ì„  ì²˜ë¦¬
      if (item.type === 'timestamp') {
        const dividerElement = dom.createElement('div', {
          className: 'timestamp-divider',
          dataset: { messageId: item.id }
        }, [
          dom.createElement('span', {
            className: 'timestamp-text',
            textContent: item.content
          })
        ]);
        
        // ì ì ˆí•œ ìœ„ì¹˜ì— ì‚½ì…
        if (previousElement) {
          previousElement.after(dividerElement);
        } else {
          elements.chatMessages.appendChild(dividerElement);
        }
        
        previousElement = dividerElement;
        return;
      }
      
      // ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬
      const message = item;
      const messageId = message.id;
      const isLastMessage = message.id === messages[messages.length - 1].id;
      const isStreamingLastMessage = isStreaming && isLastMessage && message.role === 'assistant';
      
      // ê¸°ì¡´ ë©”ì‹œì§€ ìš”ì†Œ ë˜ëŠ” ìƒˆ ìš”ì†Œ ìƒì„±
      let messageElement = elementMap[messageId];
      if (!messageElement) {
        messageElement = dom.createElement('div', {
          className: `message ${message.role}`,
          id: `msg-${messageId}`,
          dataset: { messageId: messageId }
        }, [
          dom.createElement('div', { className: 'message-content' })
        ]);
        
        // ì‚¬ìš©ì ë©”ì‹œì§€ì— ëŒ€í•œ ì½ìŒ í‘œì‹œ ì œê±°ë¨
        
        // ì ì ˆí•œ ìœ„ì¹˜ì— ì‚½ì…
        if (previousElement) {
          previousElement.after(messageElement);
        } else {
          elements.chatMessages.appendChild(messageElement);
        }
      }
      
      // ìŠ¤íŠ¸ë¦¬ë° í´ë˜ìŠ¤ ì²˜ë¦¬
      if (isStreamingLastMessage) {
        messageElement.classList.add('streaming');
      } else {
        messageElement.classList.remove('streaming');
      }
      
      // ë©”ì‹œì§€ ë‚´ìš© ì—…ë°ì´íŠ¸
      const contentElement = messageElement.querySelector('.message-content');

      try {
        const formattedContent = formatMessageContent(message.content);

        // í•­ìƒ DOM ì—…ë°ì´íŠ¸ ìµœì í™”
        if (isStreamingLastMessage) {
          // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ ë©”ì‹œì§€ ì²˜ë¦¬
          if (contentElement.innerHTML && formattedContent.startsWith(contentElement.innerHTML)) {
            // ì¦ë¶„ ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ì—¬ ì¶”ê°€ (íš¨ìœ¨ì ì¸ DOM ì—…ë°ì´íŠ¸)
            const newContent = formattedContent.substring(contentElement.innerHTML.length);
            if (newContent) {
              console.log(`[updateMessages] ì¦ë¶„ ì—…ë°ì´íŠ¸: ìƒˆ ë‚´ìš© ${newContent.length}ë°”ì´íŠ¸`);
              try {
                // DocumentFragmentë¥¼ ì‚¬ìš©í•˜ì—¬ DOM ì¡°ì‘ ìµœì†Œí™”
                const fragment = document.createRange().createContextualFragment(newContent);
                contentElement.appendChild(fragment);
              } catch (fragmentError) {
                // Fragment ì˜¤ë¥˜ ì‹œ í…ìŠ¤íŠ¸ ë…¸ë“œ ì¶”ê°€ë¡œ ëŒ€ì²´
                console.warn('[updateMessages] í”„ë˜ê·¸ë¨¼íŠ¸ ìƒì„± ì˜¤ë¥˜, í…ìŠ¤íŠ¸ ë…¸ë“œ ì¶”ê°€ë¡œ ëŒ€ì²´', fragmentError);
                contentElement.appendChild(document.createTextNode(newContent));
              }
            }
          } else {
            // ì½˜í…ì¸  ë¶ˆì¼ì¹˜ - ì „ì²´ êµì²´ í•„ìš”
            console.log(`[updateMessages] ìŠ¤íŠ¸ë¦¬ë° ì „ì²´ êµì²´: ì´ì „ ${contentElement.innerHTML.length}ë°”ì´íŠ¸ -> ìƒˆë¡œìš´ ${formattedContent.length}ë°”ì´íŠ¸`);
            contentElement.innerHTML = formattedContent;
          }
        } else if (contentElement.innerHTML !== formattedContent) {
          // ì¼ë°˜ ë©”ì‹œì§€ì´ê³  ë‚´ìš©ì´ ë‹¤ë¥¸ ê²½ìš° ì „ì²´ êµì²´
          console.log(`[updateMessages] ì¼ë°˜ ì „ì²´ êµì²´: ì´ì „ ${contentElement.innerHTML.length}ë°”ì´íŠ¸ -> ìƒˆë¡œìš´ ${formattedContent.length}ë°”ì´íŠ¸`);
          contentElement.innerHTML = formattedContent;
        }

        // í•˜ë“œì›¨ì–´ ê°€ì†ìœ¼ë¡œ ë Œë”ë§ ì„±ëŠ¥ ê°œì„ 
        messageElement.style.transform = 'translateZ(0)';
        messageElement.style.willChange = 'transform';
        messageElement.style.backfaceVisibility = 'hidden';
      } catch (error) {
        // ì˜¤ë¥˜ ë³µêµ¬ ì „ëµ: ì›ë³¸ ë‚´ìš© ì§ì ‘ í‘œì‹œ
        console.error('[updateMessages] ë©”ì‹œì§€ ì½˜í…ì¸  ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        try {
          contentElement.textContent = message.content || '(ë©”ì‹œì§€ ë Œë”ë§ ì˜¤ë¥˜)';
        } catch (finalError) {
          console.error('[updateMessages] ìµœì¢… ë³µêµ¬ ì‹¤íŒ¨:', finalError);
        }
      }
      
      previousElement = messageElement;
    });
    
    // ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ (ìƒˆ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì—ˆê±°ë‚˜ ìŠ¤íŠ¸ë¦¬ë°ì´ ì¢…ë£Œëœ ê²½ìš° ê°•ì œ ìŠ¤í¬ë¡¤)
    performSmartScroll(messages.length !== currentMessageIds.length || !isStreaming);
    
    // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
    updateStreamingState(isStreaming);
  }
  
  // íƒ€ì„ìŠ¤íƒ¬í”„ êµ¬ë¶„ì„  ì¶”ê°€
  function addTimestampDividers(messages) {
    const result = [];
    let currentGroup = null;
    
    messages.forEach((message, index) => {
      // ì´ ë©”ì‹œì§€ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ ê·¸ë£¹ ê²°ì •
      const group = getTimestampGroup(message.timestamp);
      
      // ê·¸ë£¹ì´ ë°”ë€Œì—ˆìœ¼ë©´ íƒ€ì„ìŠ¤íƒ¬í”„ êµ¬ë¶„ì„  ì¶”ê°€
      if (group !== currentGroup) {
        currentGroup = group;
        
        // ì›°ì»´ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        if (index > 0) {
          const divider = {
            id: `timestamp_${Date.now()}_${index}`,
            type: 'timestamp',
            content: format.formatDate(message.timestamp),
            timestamp: message.timestamp
          };
          result.push(divider);
        }
      }
      
      // ì‹¤ì œ ë©”ì‹œì§€ ì¶”ê°€
      result.push(message);
    });
    
    return result;
  }
  
  // íƒ€ì„ìŠ¤íƒ¬í”„ ê·¸ë£¹ ê²°ì •
  function getTimestampGroup(date) {
    if (!date) return 'unknown';
    
    const messageDate = new Date(date);
    return messageDate.toDateString();
  }
  
  // ë©”ì‹œì§€ ë‚´ìš© í¬ë§·íŒ…
  function formatMessageContent(content) {
    if (!content) return '';

    // ë””ë²„ê·¸ ë¡œê¹… ì¶”ê°€
    console.log(`[formatMessageContent] ì½˜í…ì¸  ê¸¸ì´: ${content.length}, ì‹œì‘: '${content.substring(0, 30)}...'`);

    try {
      // HTMLì´ ì´ë¯¸ í¬í•¨ëœ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
      const trimmedContent = content.trim();
      if (trimmedContent.startsWith('<') && (
        trimmedContent.includes('</div>') ||
        trimmedContent.includes('</p>') ||
        trimmedContent.includes('</h') ||
        trimmedContent.includes('</span>') ||
        trimmedContent.includes('</ul>') ||
        trimmedContent.includes('</li>') ||
        trimmedContent.includes('</table>') ||
        trimmedContent.match(/<[a-zA-Z0-9_]+[^>]*>/)
      )) {
        console.log('[formatMessageContent] HTML ì½˜í…ì¸ ë¡œ ê°ì§€, ê·¸ëŒ€ë¡œ ë°˜í™˜');
        return content;
      }
    } catch (error) {
      console.error('[formatMessageContent] HTML ê°ì§€ ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì›ë³¸ ë‚´ìš© ë°˜í™˜
      return content || '';
    }
    
    // ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ í¬ë§·íŒ…
    let formatted = content;
    
    // ì½”ë“œ ë¸”ë¡ ë³€í™˜
    formatted = formatted.replace(/```([a-zA-Z0-9_]*)\n([\s\S]*?)\n```/g, function(match, language, code) {
      return format.formatCodeBlock(code, language);
    });
    
    // ì¸ë¼ì¸ ì½”ë“œ ë³€í™˜
    formatted = formatted.replace(/`([^`]+)`/g, function(match, code) {
      return `<code class="inline-code">${dom.escapeHtml(code)}</code>`;
    });
    
    // ì²¨ë¶€ íŒŒì¼ í‘œì‹œ ê°œì„ 
    formatted = formatted.replace(/ì²¨ë¶€ëœ íŒŒì¼: ([^\n]+)/g, function(match, fileName) {
      return `<div class="attached-file">
        <span class="attachment-icon">ğŸ“</span>
        <span class="attachment-name">${fileName}</span>
        <div class="attachment-actions">
          <button class="attachment-action view-file" title="íŒŒì¼ ì—´ê¸°">
            <span class="emoji-icon">ğŸ‘ï¸</span>
          </button>
        </div>
      </div>`;
    });
    
    // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
    formatted = formatted.replace(/\n/g, '<br>');
    
    return formatted;
  }
  
  // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ UI ì—…ë°ì´íŠ¸
  function updateStreamingState(isStreaming) {
    if (!elements.sendButton || !elements.chatInput) return;
    
    if (isStreaming) {
      elements.sendButton.innerHTML = '<span class="emoji-icon">â– </span>';
      elements.sendButton.title = 'ìƒì„± ì¤‘ë‹¨';
      elements.chatInput.disabled = true;
    } else {
      elements.sendButton.innerHTML = '<span class="emoji-icon">â†‘</span>';
      elements.sendButton.title = 'ë©”ì‹œì§€ ì „ì†¡';
      elements.chatInput.disabled = false;
    }
  }
  
  // ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ê°ì§€
  function detectUserScroll() {
    if (!elements.chatMessages) return;
    
    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê³„ì‚°
    const scrollPosition = elements.chatMessages.scrollTop + elements.chatMessages.clientHeight;
    const scrollThreshold = elements.chatMessages.scrollHeight - state.SCROLL_THRESHOLD;
    
    // ìŠ¤í¬ë¡¤ì´ ë°”ë‹¥ ê·¼ì²˜ì— ìˆëŠ”ì§€ ì²´í¬
    state.isScrollNearBottom = scrollPosition >= scrollThreshold;
    
    // ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ê°ì§€
    if (!state.isScrollNearBottom) {
      state.isUserScrolled = true;
    }
  }
  
  // ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ìˆ˜í–‰
  function performSmartScroll(forceScroll = false) {
    if (!elements.chatMessages) return;

    // ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ì„ ì˜¬ë¦¬ì§€ ì•Šì•˜ê±°ë‚˜ ê°•ì œ ìŠ¤í¬ë¡¤ì´ í•„ìš”í•œ ê²½ìš°, ë˜ëŠ” ìŠ¤í¬ë¡¤ì´ ë°”ë‹¥ ê·¼ì²˜ì— ìˆëŠ” ê²½ìš°ì—ë§Œ ìŠ¤í¬ë¡¤
    if (forceScroll || !state.isUserScrolled || state.isScrollNearBottom) {
      // requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤í¬ë¡¤ ë Œë”ë§ ìµœì í™”
      requestAnimationFrame(() => {
        // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ setTimeout ì¶”ê°€
        setTimeout(() => {
          elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
          state.isUserScrolled = false;
        }, 10);
      });
    }
  }
  
  // ì…ë ¥ì°½ í¬ê¸° ìë™ ì¡°ì ˆ (debounce ì ìš©)
  const resizeInput = debounce(function() {
    if (!elements.chatInput) return;

    requestAnimationFrame(() => {
      elements.chatInput.style.height = 'auto';
      elements.chatInput.style.height = (elements.chatInput.scrollHeight) + 'px';
    });
  }, 10);
  
  // ì´ˆê¸°í™” ì‹¤í–‰
  initialize();
})();