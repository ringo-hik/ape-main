# APE Extension 기술 아키텍처 문서

이 문서는 APE Extension의 기술적 구조, 서비스, 기능 및 구현 기법을 종합적으로 설명합니다.

## 1. 핵심 서비스 및 유틸리티

### 1.1 메모리 서비스 (`MemoryService`)

- **목적**: 대화 내역 및 세션 데이터의 지속적인 저장 및 관리
- **주요 기능**:
  - 세션 생성, 전환, 저장, 불러오기
  - 메시지 저장 및 검색
  - 자동 아카이빙 및 정리
  - 파일 시스템 기반 영구 저장소
- **기술적 특징**:
  - 단일 책임 원칙을 따른 모듈식 설계
  - 비동기 파일 I/O 작업 지원
  - 세션 메타데이터 및 요약 기능
  - 메모리 유출 방지를 위한 자동 한계 설정

### 1.2 로깅 시스템 (`Logger`)

- **목적**: 체계적인 로그 관리 및 디버깅 지원
- **주요 기능**:
  - 다수준 로깅 (DEBUG, INFO, WARN, ERROR)
  - VS Code 출력 채널 통합
  - 상황별 로그 필터링
  - 설정을 통한 로그 수준 제어
- **기술적 특징**:
  - 싱글톤 패턴 구현
  - VS Code 설정 변경 이벤트 구독
  - 조건부 로깅으로 성능 최적화
  - 서비스 전반에 걸친 통합 로깅 API

### 1.3 CSP 관리 (`CSPManager`)

- **목적**: 웹뷰 컨텐츠 보안 정책(CSP) 관리
- **주요 기능**:
  - 환경별 CSP 정책 생성 (기본, 표준, 고급)
  - 안전한 nonce 생성
  - 확장 환경에 맞춤화된 CSP 규칙
- **기술적 특징**:
  - 정적 메서드 기반 유틸리티 클래스
  - 컨텍스트별 CSP 정책 생성
  - 세밀한 보안 설정 제어
  - 웹뷰 소스 기반 동적 정책 생성

## 2. LLM 서비스 및 통합

### 2.1 LLM 서비스 (`LLMService`)

- **목적**: 대규모 언어 모델 API와의 통합 및 상호작용
- **주요 기능**:
  - HTTP 및 WebSocket 연결 지원
  - 동기 및 스트리밍 응답 처리
  - API 키 및 인증 관리
  - 다양한 모델 설정 지원
- **기술적 특징**:
  - 보안 저장소를 활용한 API 키 암호화 저장
  - 재시도 메커니즘 및 오류 처리
  - 요청 취소 지원
  - 다양한 응답 형식 통합 처리
  - 청크 단위 스트리밍 최적화

### 2.2 모델 관리 (`ModelManager`)

- **목적**: LLM 모델 구성 및 설정 관리
- **주요 기능**:
  - 모델 변경 및 상태 추적
  - 사용자 정의 모델 구성
  - 모델 메타데이터 및 호환성 관리
- **기술적 특징**:
  - 이벤트 기반 상태 관리
  - VS Code 설정과 통합
  - 확장 가능한 모델 등록 시스템
  - 헤더 및 메타데이터 주입 지원

### 2.3 VAULT 통합 (`vaultIntegration`)

- **목적**: LLM 요청에 컨텍스트 정보 주입
- **주요 기능**:
  - 컨텍스트 아이템 검색 및 필터링
  - LLM 프롬프트 컨텍스트 통합
  - 다양한 결합 모드 (prepend, append, replace)
- **기술적 특징**:
  - 요청 확장을 위한 인터페이스 확장
  - 효율적인 컨텍스트 관리
  - 유연한 필터링 옵션

### 2.4 Rules 통합 (`rulesIntegration`)

- **목적**: LLM 요청에 규칙 기반 시스템 프롬프트 적용
- **주요 기능**:
  - 룰 기반 프롬프트 생성
  - 기존 시스템 메시지와 통합
- **기술적 특징**:
  - 요청 확장을 위한 인터페이스 확장
  - 규칙 및 시스템 메시지 병합 최적화

## 3. 명령어 시스템 및 슬래시 명령어

### 3.1 명령 관리자 (`CommandManager`)

- **목적**: 모든 명령어 중앙 관리 및 실행
- **주요 기능**:
  - VS Code 명령 등록
  - 슬래시 명령어 관리자와 통합
  - UI 명령 실행 API 제공
- **기술적 특징**:
  - 팩토리 패턴을 통한 명령어 생성
  - 명령어 수명 주기 관리
  - 의존성 주입을 통한 서비스 통합

### 3.2 슬래시 명령어 관리자 (`SlashCommandManager`)

- **목적**: 채팅 인터페이스 내 슬래시 명령어 처리
- **주요 기능**:
  - 명령어 등록, 제안, 실행
  - 이중 언어 지원 (한국어/영어)
  - 명령어 자동 완성
  - 도움말 및 설명 제공
- **기술적 특징**:
  - 자연어 의도 기반 매칭
  - 레벤슈타인 거리 알고리즘을 활용한 유사 명령어 제안
  - 계층적 명령어 구조
  - 이벤트 기반 제안 시스템

### 3.3 도움말 렌더러 (`helpRenderer`)

- **목적**: 명령어 도움말 및 문서 생성
- **주요 기능**:
  - 카테고리별 도움말 페이지 생성
  - 명령어 상세 정보 표시
  - FAQ 및 가이드 제공
  - LLM 기반 스마트 도움말
- **기술적 특징**:
  - HTML 기반 포맷팅
  - 템플릿 메서드 패턴
  - 정보 계층화

## 4. Git 관련 서비스

### 4.1 자동 커밋 서비스 (`AutoCommitService`)

- **목적**: Git 상태 관리 및 자동 커밋 기능
- **주요 기능**:
  - 자동 커밋 토글 기능
  - 커밋 메시지 자동 생성
  - 임시 커밋 통합
  - Git 상태 모니터링
- **기술적 특징**:
  - VS Code 상태 표시줄 통합
  - 파일 시스템 이벤트 모니터링
  - LLM 기반 커밋 메시지 생성
  - 대용량 저장소 지원을 위한 버퍼 사이즈 최적화

### 4.2 충돌 해결기 (`ConflictSolver`)

- **목적**: Git 충돌 자동 해결
- **주요 기능**:
  - 충돌 파일 감지
  - 다양한 해결 전략 제공 (ours, theirs, merge, llm)
  - 파일 유형별 최적 전략 결정
  - LLM 기반 지능형 병합
- **기술적 특징**:
  - 충돌 패턴 정규식 분석
  - 파일 유형별 전략 최적화
  - 줄 단위 병합 알고리즘
  - LLM 기반 코드 병합

### 4.3 BitBucket 서비스 (`BitbucketService`)

- **목적**: BitBucket API 연동
- **주요 기능**:
  - 커밋 이력 검색
  - 사용자 이름 및 설정 가져오기
  - PR 관련 기능 지원
- **기술적 특징**:
  - API 인증 및 요청 관리
  - 응답 캐싱 및 최적화
  - 오류 처리 및 재시도

## 5. 플러그인 시스템

### 5.1 플러그인 레지스트리 (`PluginRegistryImpl`)

- **목적**: 플러그인 수명 주기 관리
- **주요 기능**:
  - 플러그인 발견, 등록, 로드, 활성화, 비활성화
  - 플러그인 상태 추적
  - 의존성 해결
- **기술적 특징**:
  - 이벤트 기반 상태 변경 알림
  - 지연 로딩 메커니즘
  - 의존성 그래프 관리

### 5.2 플러그인 로더

- **목적**: 다양한 소스에서 플러그인 로드
- **주요 컴포넌트**:
  - `JsonPluginLoader`: JSON 기반 플러그인 처리
  - `SettingsPluginLoader`: VS Code 설정 기반 플러그인 처리
- **기술적 특징**:
  - 선언적 플러그인 정의 지원
  - 메타데이터 검증 및 처리
  - 플러그인 캐싱 및 최적화

### 5.3 플러그인 API (`PluginAPI`)

- **목적**: 플러그인을 위한 기능 접근점 제공
- **주요 기능**:
  - VS Code API 접근
  - LLM 서비스 접근
  - 메모리 서비스 접근
  - UI 서비스 접근
  - 파일 시스템, Git, 워크스페이스 접근
- **기술적 특징**:
  - 기능별 API 모듈화
  - 타입 안전성 보장
  - 확장 가능한 인터페이스 설계

### 5.4 이벤트 시스템

- **목적**: 플러그인 간 통신 지원
- **주요 기능**:
  - 플러그인 수명 주기 이벤트
  - 플러그인 간 이벤트 구독 및 발행
  - 상태 변경 알림
- **기술적 특징**:
  - 커스텀 이벤트 이미터
  - 타입 안전 이벤트 처리
  - 플러그인 간 결합도 감소

### 5.5 슬래시 명령어 통합

- **목적**: 플러그인이 슬래시 명령어 제공
- **주요 기능**:
  - HTTP 요청 핸들러
  - 템플릿 핸들러
  - 함수 핸들러
- **기술적 특징**:
  - LLM 기반 파라미터 추출
  - 파라미터 검증 및 변환
  - 템플릿 기반 응답 포맷팅

## 6. UI 시스템 및 최적화

### 6.1 웹뷰 아키텍처

- **목적**: VS Code 웹뷰 기반 UI 제공
- **주요 컴포넌트**:
  - `BaseWebViewProvider`: 모든 웹뷰의 기본 클래스
  - `ChatViewProvider`: 채팅 UI 제공
  - `CommandFormProvider`: 명령어 폼 UI 제공
- **기술적 특징**:
  - 템플릿 메서드 패턴 사용
  - HTML, CSS, JavaScript 통합
  - 메시지 통신 최적화
  - 웹뷰 리소스 효율적 관리

### 6.2 CSP 구현

- **목적**: 웹뷰 보안 강화
- **주요 기능**:
  - 세 가지 CSP 수준 정의 (기본, 표준, 고급)
  - 안전한 nonce 생성
  - 웹뷰 소스 기반 동적 CSP 구성
- **기술적 특징**:
  - 최소 권한 원칙 적용
  - 세밀한 리소스 접근 제어
  - 확장 가능한 CSP 프로필 설계

### 6.3 트리 뷰 구현

- **목적**: 확장 기능 탐색 및 접근 UI
- **주요 컴포넌트**:
  - `ApeTreeDataProvider`: 트리 데이터 제공
  - `TreeNodeType`: 노드 유형 정의
  - `TreeViewIntegration`: VS Code 트리 뷰 통합
- **기술적 특징**:
  - 지연 로딩 및 확장
  - 이벤트 기반 UI 갱신
  - 아이콘 및 컨텍스트 메뉴 최적화
  - 조건부 렌더링

### 6.4 성능 최적화 기법

- **디버깅 및 로깅**:
  - 조건부 로깅으로 성능 오버헤드 감소
  - 로그 레벨 기반 필터링
  - 개발/배포 모드 구분

- **메모리 관리**:
  - 자동 청소 시스템
  - 명시적 리소스 해제
  - 이벤트 핸들러 정리

- **UI 반응성**:
  - 비동기 작업 처리
  - 작업 단위 지연 로드
  - 렌더링 최적화

- **이벤트 처리**:
  - 이벤트 디바운싱
  - 이벤트 위임
  - 구독 관리 최적화

## 7. 테스트 프레임워크

### 7.1 테스트 종류

- **기본 테스트**: VS Code 확장의 기본 기능 검증
- **LLM 자체 테스트**: LLM 서비스 코어 기능 검증
- **LLM 종합 테스트**: LLM 서비스와 UI 통합 테스트
- **웹뷰 테스트**: 실제 VS Code 웹뷰 환경에서의 통합 테스트

### 7.2 테스트 아키텍처

- **주요 컴포넌트**:
  - `TestOrchestrator`: 테스트 흐름 조정
  - `ScenarioRunner`: 테스트 시나리오 실행
  - `WebviewDOMValidator`: 웹뷰 DOM 검증
  - `LogCollector` & `LogAnalyzer`: 로그 수집 및 분석
  - `CodeAnalyzer`: 코드 분석 및 자동 수정

- **기술적 특징**:
  - WebdriverIO 기반 테스트 자동화
  - 시나리오 기반 테스트 설계
  - 로그 및 DOM 분석
  - 자동 코드 수정

### 7.3 테스트 전략

- **모킹 시스템**:
  - LLM 서비스 모킹
  - 응답 템플릿
  - 모의 브라우저 환경

- **시나리오 기반 테스트**:
  - JSON 정의 시나리오
  - 재사용 가능한 테스트 단계
  - WebdriverIO 커맨드 시퀀스

- **자동화 및 CI/CD**:
  - 테스트 자동화 스크립트
  - 결과 보고 시스템
  - 전체/부분 테스트 실행

## 8. 결론

APE Extension은 다양한 서비스와 기능을 효율적으로 통합하기 위해 모듈화된 아키텍처를 채택하고 있습니다. 코어 서비스(메모리, 로깅, CSP)는 확장 전반에 걸쳐 기반 기능을 제공하며, LLM 서비스는 대규모 언어 모델과의 통합을 담당합니다. 명령어 시스템은 사용자 상호작용의 핵심이며, Git 서비스와 플러그인 시스템은 확장성을 극대화합니다.

UI 시스템은 웹뷰를 기반으로 최적화된 사용자 경험을 제공하며, 테스트 프레임워크는 지속적인 품질 유지를 지원합니다. 전체적으로 APE Extension은 고성능, 확장성, 유지 관리성을 균형 있게 갖춘 견고한 아키텍처를 기반으로 구축되었습니다.